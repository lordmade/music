<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
Â  <title>Vynix Chat</title>
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js"></script>
Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
Â  <style>
Â  Â  :root {
Â  Â  Â  --bg: linear-gradient(135deg, #F7F7F8, #E0E7FF);
Â  Â  Â  --card-bg: #1C2526;
Â  Â  Â  --text-primary: #FFFFFF;
Â  Â  Â  --text-secondary: #4B5EAA;
Â  Â  Â  --border: #4A5568;
Â  Â  Â  --highlight: #38B2AC;
Â  Â  Â  --user-msg-bg: #E0E7FF;
Â  Â  Â  --ai-msg-bg: #1C2526;
Â  Â  }

Â  Â  body {
Â  Â  Â  font-family: 'Inter', system-ui, sans-serif;
Â  Â  Â  background: var(--bg);
Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  min-height: 100vh;
Â  Â  Â  margin: 0;
Â  Â  Â  transition: background 0.3s ease;
Â  Â  Â  scroll-behavior: smooth;
Â  Â  }

Â  Â  .tab-container {
Â  Â  Â  position: fixed;
Â  Â  Â  bottom: 0;
Â  Â  Â  left: 0;
Â  Â  Â  right: 0;
Â  Â  Â  padding: 0.5rem;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-around;
Â  Â  Â  align-items: center;
Â  Â  Â  z-index: 10;
Â  Â  Â  background: linear-gradient(135deg, var(--card-bg), #2D3748);
Â  Â  Â  border-top: 1px solid var(--border);
Â  Â  Â  box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.2);
Â  Â  Â  border-top-left-radius: 1rem;
Â  Â  Â  border-top-right-radius: 1rem;
Â  Â  }

Â  Â  .tab {
Â  Â  Â  background: transparent;
Â  Â  Â  color: var(--text-primary);
Â  Â  Â  padding: 0.5rem;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: color 0.3s, transform 0.2s;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 0.25rem;
Â  Â  Â  font-size: 0.75rem;
Â  Â  Â  flex: 1;
Â  Â  Â  text-align: center;
Â  Â  }

Â  Â  .tab:hover, .tab.active {
Â  Â  Â  color: var(--highlight);
Â  Â  Â  transform: translateY(-2px);
Â  Â  }

Â  Â  .tab svg {
Â  Â  Â  width: 1.5rem;
Â  Â  Â  height: 1.5rem;
Â  Â  Â  stroke: currentColor;
Â  Â  Â  transition: stroke 0.3s;
Â  Â  }

Â  Â  .hidden {
Â  Â  Â  display: none;
Â  Â  }

Â  Â  .friends-list, .status-list, .calls-list {
Â  Â  Â  margin: 1rem 0 5rem 0;
Â  Â  Â  padding: 0 1rem;
Â  Â  Â  overflow-y: auto;
Â  Â  Â  max-height: calc(100vh - 6rem);
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  gap: 0.5rem;
Â  Â  }

Â  Â  .friend-card, .status-card, .call-card {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  padding: 1rem;
Â  Â  Â  background: linear-gradient(135deg, #FFFFFF, #F7F7F8);
Â  Â  Â  border-radius: 1rem;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
Â  Â  Â  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
Â  Â  }

Â  Â  .friend-card:hover, .status-card:hover, .call-card:hover {
Â  Â  Â  background: linear-gradient(135deg, #E0E7FF, #C7D2FE);
Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
Â  Â  }

Â  Â  .friend-card .avatar, .status-card .avatar, .call-card .avatar {
Â  Â  Â  width: 3rem;
Â  Â  Â  height: 3rem;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  margin-right: 1rem;
Â  Â  Â  background: var(--highlight);
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  font-size: 1.5rem;
Â  Â  Â  font-weight: 600;
Â  Â  Â  color: var(--text-primary);
Â  Â  Â  border: 2px solid var(--highlight);
Â  Â  Â  transition: border-color 0.3s;
Â  Â  }

Â  Â  .friend-card img, .status-card img, .call-card img {
Â  Â  Â  width: 3rem;
Â  Â  Â  height: 3rem;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  margin-right: 1rem;
Â  Â  Â  border: 2px solid var(--highlight);
Â  Â  Â  transition: border-color 0.3s;
Â  Â  Â  object-fit: cover;
Â  Â  }

Â  Â  .friend-info, .status-info, .call-info {
Â  Â  Â  flex: 1;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  }

Â  Â  .friend-info h3, .status-info h3, .call-info h3 {
Â  Â  Â  margin: 0;
Â  Â  Â  font-size: 1.125rem;
Â  Â  Â  font-weight: 600;
Â  Â  Â  color: #1E1E1E;
Â  Â  }

Â  Â  .friend-info .last-seen, .status-info .last-seen, .call-info .last-seen {
Â  Â  Â  font-size: 0.75rem;
Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  opacity: 0.6;
Â  Â  }

Â  Â  .friend-info p, .status-info p, .call-info p {
Â  Â  Â  margin: 0;
Â  Â  Â  font-size: 0.875rem;
Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  opacity: 0.8;
Â  Â  Â  max-width: 200px;
Â  Â  Â  white-space: nowrap;
Â  Â  Â  overflow: hidden;
Â  Â  Â  text-overflow: ellipsis;
Â  Â  }

Â  Â  .timestamp {
Â  Â  Â  font-size: 0.75rem;
Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  opacity: 0.6;
Â  Â  Â  margin-left: auto;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 0.5rem;
Â  Â  }

Â  Â  .unread-count {
Â  Â  Â  background: var(--highlight);
Â  Â  Â  color: var(--text-primary);
Â  Â  Â  font-size: 0.75rem;
Â  Â  Â  font-weight: 600;
Â  Â  Â  padding: 0.25rem 0.5rem;
Â  Â  Â  border-radius: 1rem;
Â  Â  Â  min-width: 1.5rem;
Â  Â  Â  text-align: center;
Â  Â  }

Â  Â  .add-friend-button {
Â  Â  Â  position: fixed;
Â  Â  Â  bottom: 5.5rem;
Â  Â  Â  right: 1.5rem;
Â  Â  Â  background: var(--highlight);
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  width: 3.5rem;
Â  Â  Â  height: 3.5rem;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  cursor: pointer;
Â  Â  Â  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
Â  Â  Â  transition: background 0.3s, transform 0.2s;
Â  Â  Â  z-index: 20;
Â  Â  }

Â  Â  .add-friend-button:hover {
Â  Â  Â  background: #2C7A74;
Â  Â  Â  transform: scale(1.05);
Â  Â  }

Â  Â  .add-friend-button svg {
Â  Â  Â  width: 1.75rem;
Â  Â  Â  height: 1.75rem;
Â  Â  Â  stroke: var(--text-primary);
Â  Â  }

Â  Â  #sidebar {
Â  Â  Â  transform: translateX(-100%);
Â  Â  Â  transition: transform 0.3s ease;
Â  Â  }

Â  Â  #sidebar.open {
Â  Â  Â  transform: translateX(0);
Â  Â  }

Â  Â  .conversation-item {
Â  Â  Â  padding: 0.75rem;
Â  Â  Â  color: var(--text-primary);
Â  Â  Â  cursor: pointer;
Â  Â  Â  border-bottom: 1px solid var(--border);
Â  Â  Â  transition: background 0.3s;
Â  Â  }

Â  Â  .conversation-item:hover {
Â  Â  Â  background: var(--highlight);
Â  Â  }

Â  Â  #hamburger-button {
Â  Â  Â  background: var(--card-bg);
Â  Â  Â  border: none;
Â  Â  Â  padding: 0.4rem;
Â  Â  Â  cursor: pointer;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  transition: background 0.3s, transform 0.2s;
Â  Â  Â  width: 2.5rem;
Â  Â  Â  height: 2.5rem;
Â  Â  Â  position: fixed;
Â  Â  Â  top: 1rem;
Â  Â  Â  left: 1rem;
Â  Â  Â  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
Â  Â  }

Â  Â  #hamburger-button:hover {
Â  Â  Â  background: var(--highlight);
Â  Â  Â  transform: rotate(90deg);
Â  Â  }

Â  Â  #hamburger-button svg {
Â  Â  Â  width: 1.25rem;
Â  Â  Â  height: 1.25rem;
Â  Â  Â  stroke: var(--text-primary);
Â  Â  }

Â  Â  .status-input-container {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 0.5rem;
Â  Â  Â  margin-bottom: 1rem;
Â  Â  }

Â  Â  .status-input {
Â  Â  Â  flex: 1;
Â  Â  Â  padding: 0.75rem;
Â  Â  Â  border: 1px solid var(--border);
Â  Â  Â  border-radius: 0.5rem;
Â  Â  Â  background: #FFFFFF;
Â  Â  Â  color: #1E1E1E;
Â  Â  Â  font-size: 1rem;
Â  Â  Â  outline: none;
Â  Â  }

Â  Â  .status-upload-button, .status-image-button {
Â  Â  Â  background: var(--highlight);
Â  Â  Â  color: var(--text-primary);
Â  Â  Â  padding: 0.75rem;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 0.5rem;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-size: 0.875rem;
Â  Â  Â  transition: background 0.3s;
Â  Â  }

Â  Â  .status-upload-button:hover, .status-image-button:hover {
Â  Â  Â  background: #2C7A74;
Â  Â  }

Â  Â  .status-image {
Â  Â  Â  max-width: 100%;
Â  Â  Â  max-height: 100px;
Â  Â  Â  border-radius: 0.5rem;
Â  Â  Â  margin-top: 0.5rem;
Â  Â  Â  object-fit: cover;
Â  Â  }

Â  Â  .status-viewer-count {
Â  Â  Â  font-size: 0.75rem;
Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  opacity: 0.6;
Â  Â  }

Â  Â  .status-viewer-overlay {
Â  Â  Â  position: fixed;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  right: 0;
Â  Â  Â  bottom: 0;
Â  Â  Â  background: rgba(0, 0, 0, 0.9);
Â  Â  Â  z-index: 50;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  opacity: 0;
Â  Â  Â  pointer-events: none;
Â  Â  Â  transition: opacity 0.3s ease;
Â  Â  }

Â  Â  .status-viewer-overlay.open {
Â  Â  Â  opacity: 1;
Â  Â  Â  pointer-events: auto;
Â  Â  }

Â  Â  .status-viewer-content {
Â  Â  Â  max-width: 90%;
Â  Â  Â  max-height: 80vh;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 1rem;
Â  Â  }

Â  Â  .status-viewer-content img {
Â  Â  Â  max-width: 100%;
Â  Â  Â  max-height: 60vh;
Â  Â  Â  border-radius: 0.5rem;
Â  Â  Â  object-fit: contain;
Â  Â  }

Â  Â  .status-viewer-content p {
Â  Â  Â  color: var(--text-primary);
Â  Â  Â  font-size: 1rem;
Â  Â  Â  text-align: center;
Â  Â  }

Â  Â  .status-viewer-close {
Â  Â  Â  background: var(--highlight);
Â  Â  Â  color: var(--text-primary);
Â  Â  Â  padding: 0.5rem 1rem;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 0.5rem;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-size: 0.875rem;
Â  Â  Â  transition: background 0.3s;
Â  Â  }

Â  Â  .status-viewer-close:hover {
Â  Â  Â  background: #2C7A74;
Â  Â  }
Â  </style>
</head>
<body>
Â  <main class="flex flex-col h-screen">
Â  Â  <button id="hamburger-button" class="w-10 h-10 rounded-full flex items-center justify-center shadow-lg transition">
Â  Â  Â  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
Â  Â  Â  Â  <path d="M4 6h16M4 12h16M4 18h16"/>
Â  Â  Â  </svg>
Â  Â  </button>
Â  Â  <div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-gray-900 hidden flex-col transition-transform duration-300 ease-in-out">
Â  Â  Â  <button id="close-sidebar" class="p-4">
Â  Â  Â  Â  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
Â  Â  Â  Â  Â  <path d="M6 18L18 6M6 6l12 12"/>
Â  Â  Â  Â  </svg>
Â  Â  Â  </button>
Â  Â  Â  <div id="conversation-list" class="flex-1 overflow-y-auto p-4"></div>
Â  Â  </div>

Â  Â  Â  Â  <div class="friends-list" id="chats-content"></div>
Â  Â  <div class="status-list hidden" id="status-content">
Â  Â  Â  <div class="status-input-container">
Â  Â  Â  Â  <input type="text" id="status-input" placeholder="What's on your mind?" aria-label="Your status">
Â  Â  Â  Â  <button class="status-upload-button">Post</button>
Â  Â  Â  Â  <label class="status-image-button">
Â  Â  Â  Â  Â  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" style="width: 1.25rem; height: 1.25rem;">
Â  Â  Â  Â  Â  Â  <path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  <input type="file" id="status-image-input" accept="image/*" hidden>
Â  Â  Â  Â  </label>
Â  Â  Â  </div>
Â  Â  Â  <div id="my-status"></div>
Â  Â  Â  <div id="friends-statuses"></div>
Â  Â  </div>
Â  Â  <div class="calls-list hidden" id="calls-content">
Â  Â  Â  <h2 style="font-size: 1.5rem; color: #1E1E1E; margin-bottom: 1rem; text-align: center;">Recent Calls</h2>
Â  Â  Â  <div id="call-history" style="font-size: 1rem; color: #4B5EAA;">
Â  Â  Â  Â  <div class="call-card">
Â  Â  Â  Â  Â  <div class="avatar" style="background: #E0E7FF; color: #4B5EAA;">ðŸ“ž</div>
Â  Â  Â  Â  Â  <div class="call-info">
Â  Â  Â  Â  Â  Â  <h3>Jane Doe</h3>
Â  Â  Â  Â  Â  Â  <p>Outgoing Call - 5 minutes ago</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <span class="timestamp">2:30 PM</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="call-card">
Â  Â  Â  Â  Â  <div class="avatar" style="background: #E0E7FF; color: #4B5EAA;">ðŸ“ž</div>
Â  Â  Â  Â  Â  <div class="call-info">
Â  Â  Â  Â  Â  Â  <h3>John Smith</h3>
Â  Â  Â  Â  Â  Â  <p>Incoming Call - 10 minutes ago</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <span class="timestamp">2:25 PM</span>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  
Â  Â  <div class="tab-container">
Â  Â  Â  <button class="tab active" data-target="chats-content" id="chats-tab">
Â  Â  Â  Â  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
Â  Â  Â  Â  Â  <path d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Chats
Â  Â  Â  </button>
Â  Â  Â  <button class="tab" data-target="status-content" id="status-tab">
Â  Â  Â  Â  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
Â  Â  Â  Â  Â  <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 6a2 2 0 110-4 2 2 0 010 4z"/>
Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Status
Â  Â  Â  </button>
Â  Â  Â  <button class="tab" data-target="calls-content" id="calls-tab">
Â  Â  Â  Â  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
Â  Â  Â  Â  Â  <path d="M20 7l-3-3m0 0l-3 3m3-3v12"/>
Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Calls
Â  Â  Â  </button>
Â  Â  </div>
Â  Â  <button class="add-friend-button" id="add-friend-button">
Â  Â  Â  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
Â  Â  Â  Â  <path d="M12 4v8m0 0v8m8-8H4"/>
Â  Â  Â  </svg>
Â  Â  </button>
Â  Â  <div class="status-viewer-overlay hidden" id="status-viewer-overlay">
Â  Â  Â  <div class="status-viewer-content" id="status-viewer-content"></div>
Â  Â  Â  <button class="status-viewer-close">Close</button>
Â  Â  </div>
Â  </main>
Â  <script type="module">
Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
Â  Â  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
Â  Â  import { getDatabase, ref, onValue, limitToLast, query, set, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
Â  Â  import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
Â  Â  Â  authDomain: "fire-b-a8878.firebaseapp.com",
Â  Â  Â  databaseURL: "https://fire-b-a8878.firebaseio.com",
Â  Â  Â  projectId: "fire-b-a8878",
Â  Â  Â  storageBucket: "fire-b-a8878.firebasestorage.app",
Â  Â  Â  messagingSenderId: "658673187627",
Â  Â  Â  appId: "1:658673187627:web:6e4c29af661785f0afa36e",
Â  Â  Â  measurementId: "G-V4W97VMSKL"
Â  Â  };

Â  Â  const state = {
Â  Â  Â  friends: [],
Â  Â  Â  currentUser: null,
Â  Â  Â  encryptionKeys: {}
Â  Â  };

Â  Â  const elements = {
Â  Â  Â  chatsContent: document.getElementById('chats-content'),
Â  Â  Â  statusContent: document.getElementById('status-content'),
Â  Â  Â  callsContent: document.getElementById('calls-content'),
Â  Â  Â  friendsList: document.getElementById('friends-list'), // This ID is now on chats-content
Â  Â  Â  statusList: document.getElementById('status-list'), // This ID is now on status-content
Â  Â  Â  myStatus: document.getElementById('my-status'),
Â  Â  Â  friendsStatuses: document.getElementById('friends-statuses'),
Â  Â  Â  statusInput: document.getElementById('status-input'),
Â  Â  Â  statusImageInput: document.getElementById('status-image-input'),
Â  Â  Â  statusUploadButton: document.querySelector('.status-upload-button'),
Â  Â  Â  statusViewerOverlay: document.getElementById('status-viewer-overlay'),
Â  Â  Â  statusViewerContent: document.getElementById('status-viewer-content'),
Â  Â  Â  statusViewerClose: document.querySelector('.status-viewer-close'),
Â  Â  Â  hamburgerButton: document.getElementById('hamburger-button'),
Â  Â  Â  sidebar: document.getElementById('sidebar'),
Â  Â  Â  closeSidebar: document.getElementById('close-sidebar'),
Â  Â  Â  conversationList: document.getElementById('conversation-list'),
Â  Â  Â  addFriendButton: document.getElementById('add-friend-button'),
Â  Â  Â  chatsTab: document.getElementById('chats-tab'),
Â  Â  Â  statusTab: document.getElementById('status-tab'),
Â  Â  Â  callsTab: document.getElementById('calls-tab')
Â  Â  };

Â  Â  let app, auth, db, storage;

Â  Â  // Encryption Functions
Â  Â  async function generateEncryptionKey() {
Â  Â  Â  return await crypto.subtle.generateKey(
Â  Â  Â  Â  { name: "AES-GCM", length: 256 },
Â  Â  Â  Â  true,
Â  Â  Â  Â  ["encrypt", "decrypt"]
Â  Â  Â  );
Â  Â  }

Â  Â  async function exportKey(key) {
Â  Â  Â  const exported = await crypto.subtle.exportKey("raw", key);
Â  Â  Â  return btoa(String.fromCharCode(...new Uint8Array(exported)));
Â  Â  }

Â  Â  async function importKey(base64Key) {
Â  Â  Â  const keyBuffer = Uint8Array.from(atob(base64Key), c => c.charCodeAt(0));
Â  Â  Â  return await crypto.subtle.importKey(
Â  Â  Â  Â  "raw",
Â  Â  Â  Â  keyBuffer,
Â  Â  Â  Â  { name: "AES-GCM" },
Â  Â  Â  Â  true,
Â  Â  Â  Â  ["encrypt", "decrypt"]
Â  Â  Â  );
Â  Â  }

Â  Â  async function encryptMessage(message, key) {
Â  Â  Â  const encoder = new TextEncoder();
Â  Â  Â  const iv = crypto.getRandomValues(new Uint8Array(12));
Â  Â  Â  const encrypted = await crypto.subtle.encrypt(
Â  Â  Â  Â  { name: "AES-GCM", iv },
Â  Â  Â  Â  key,
Â  Â  Â  Â  encoder.encode(message)
Â  Â  Â  );
Â  Â  Â  return {
Â  Â  Â  Â  ciphertext: btoa(String.fromCharCode(...new Uint8Array(encrypted))),
Â  Â  Â  Â  iv: btoa(String.fromCharCode(...iv))
Â  Â  Â  };
Â  Â  }

Â  Â  async function decryptMessage(ciphertext, iv, key) {
Â  Â  Â  try {
Â  Â  Â  Â  const decoder = new TextDecoder();
Â  Â  Â  Â  const encryptedBuffer = Uint8Array.from(atob(ciphertext), c => c.charCodeAt(0));
Â  Â  Â  Â  const ivBuffer = Uint8Array.from(atob(iv), c => c.charCodeAt(0));
Â  Â  Â  Â  const decrypted = await crypto.subtle.decrypt(
Â  Â  Â  Â  Â  { name: "AES-GCM", iv: ivBuffer },
Â  Â  Â  Â  Â  key,
Â  Â  Â  Â  Â  encryptedBuffer
Â  Â  Â  Â  );
Â  Â  Â  Â  return decoder.decode(decrypted);
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error('Decryption failed:', e);
Â  Â  Â  Â  return '[Decryption Error]';
Â  Â  Â  }
Â  Â  }

Â  Â  async function getChatKey(chatId) {
Â  Â  Â  if (state.encryptionKeys[chatId]) {
Â  Â  Â  Â  return state.encryptionKeys[chatId];
Â  Â  Â  }
Â  Â  Â  const keyRef = ref(db, `chatKeys/${chatId}/key`);
Â  Â  Â  const snapshot = await new Promise(resolve => onValue(keyRef, resolve, { onlyOnce: true }));
Â  Â  Â  if (snapshot.exists()) {
Â  Â  Â  Â  const base64Key = snapshot.val();
Â  Â  Â  Â  state.encryptionKeys[chatId] = await importKey(base64Key);
Â  Â  Â  Â  return state.encryptionKeys[chatId];
Â  Â  Â  } else {
Â  Â  Â  Â  const newKey = await generateEncryptionKey();
Â  Â  Â  Â  const base64Key = await exportKey(newKey);
Â  Â  Â  Â  await set(keyRef, base64Key);
Â  Â  Â  Â  state.encryptionKeys[chatId] = newKey;
Â  Â  Â  Â  return newKey;
Â  Â  Â  }
Â  Â  }

Â  Â  function initializeFirebase() {
Â  Â  Â  app = initializeApp(firebaseConfig);
Â  Â  Â  auth = getAuth(app);
Â  Â  Â  db = getDatabase(app);
Â  Â  Â  storage = getStorage(app);
Â  Â  Â  onAuthStateChanged(auth, (user) => {
Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  state.currentUser = user;
Â  Â  Â  Â  Â  setupPresence(user.uid);
Â  Â  Â  Â  Â  loadFriends();
Â  Â  Â  Â  Â  loadStatuses();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  window.location.href = 'signup.html';
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  function setupPresence(userId) {
Â  Â  Â  const userStatusRef = ref(db, `users/${userId}/status`);
Â  Â  Â  const lastSeenRef = ref(db, `users/${userId}/lastSeen`);
Â  Â  Â  set(userStatusRef, 'online');
Â  Â  Â  onDisconnect(userStatusRef).set('offline');
Â  Â  Â  onDisconnect(lastSeenRef).set(serverTimestamp());
Â  Â  }

Â  Â  async function loadFriends() {
Â  Â  Â  const friendsRef = ref(db, `users/${state.currentUser.uid}/friends`);
Â  Â  Â  onValue(friendsRef, async (snapshot) => {
Â  Â  Â  Â  elements.chatsContent.innerHTML = '';
Â  Â  Â  Â  state.friends = [];
Â  Â  Â  Â  const friendPromises = [];
Â  Â  Â  Â  
Â  Â  Â  Â  if (snapshot.exists()) {
Â  Â  Â  Â  Â  const friends = snapshot.val();
Â  Â  Â  Â  Â  for (const friendUid in friends) {
Â  Â  Â  Â  Â  Â  friendPromises.push(
Â  Â  Â  Â  Â  Â  Â  new Promise(async (resolve) => {
Â  Â  Â  Â  Â  Â  Â  Â  const userRef = ref(db, `users/${friendUid}`);
Â  Â  Â  Â  Â  Â  Â  Â  const userSnapshot = await new Promise(resolve => onValue(userRef, resolve, { onlyOnce: true }));
Â  Â  Â  Â  Â  Â  Â  Â  const user = userSnapshot.val();
Â  Â  Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  const { lastMessage, messageTimestamp, unreadCount } = await loadLastMessage(friendUid);
Â  Â  Â  Â  Â  Â  Â  Â  Â  const lastSeenTime = user.lastSeen 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? `Last seen ${new Date(user.lastSeen).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : 'Last seen recently';
Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uid: friendUid,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayName: user.displayName || 'User',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  email: user.email,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  photoURL: user.photoURL || null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastSeen: lastSeenTime,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastMessage: lastMessage ? lastMessage.slice(0, 50) + (lastMessage.length > 50 ? '...' : '') : '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  messageTimestamp: messageTimestamp ? new Date(messageTimestamp).getTime() : 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unreadCount
Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  state.friends = await Promise.all(friendPromises);
Â  Â  Â  Â  state.friends.sort((a, b) => {
Â  Â  Â  Â  Â  if (a.unreadCount > 0 && b.unreadCount > 0) {
Â  Â  Â  Â  Â  Â  return b.unreadCount - a.unreadCount;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if (a.unreadCount > 0) return -1;
Â  Â  Â  Â  Â  if (b.unreadCount > 0) return 1;
Â  Â  Â  Â  Â  return b.messageTimestamp - a.messageTimestamp;
Â  Â  Â  Â  });

Â  Â  Â  Â  state.friends.forEach(friend => appendFriendCard(friend));
Â  Â  Â  });
Â  Â  }

Â  Â  async function loadLastMessage(friendId) {
Â  Â  Â  const chatId = [state.currentUser.uid, friendId].sort().join('_');
Â  Â  Â  const messagesRef = query(ref(db, `chats/${chatId}`), limitToLast(1));
Â  Â  Â  const key = await getChatKey(chatId);
Â  Â  Â  return new Promise((resolve) => {
Â  Â  Â  Â  onValue(messagesRef, async (snapshot) => {
Â  Â  Â  Â  Â  let lastMessage = '';
Â  Â  Â  Â  Â  let messageTimestamp = '';
Â  Â  Â  Â  Â  let unreadCount = 0;
Â  Â  Â  Â  Â  if (snapshot.exists()) {
Â  Â  Â  Â  Â  Â  snapshot.forEach((child) => {
Â  Â  Â  Â  Â  Â  Â  const msg = child.val();
Â  Â  Â  Â  Â  Â  Â  lastMessage = msg.ciphertext ? decryptMessage(msg.ciphertext, msg.iv, key) : '';
Â  Â  Â  Â  Â  Â  Â  messageTimestamp = msg.timestamp;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const allMessagesRef = ref(db, `chats/${chatId}`);
Â  Â  Â  Â  Â  Â  onValue(allMessagesRef, (allSnapshot) => {
Â  Â  Â  Â  Â  Â  Â  unreadCount = 0;
Â  Â  Â  Â  Â  Â  Â  if (allSnapshot.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  allSnapshot.forEach((msg) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (msg.val().unread && msg.val().sender !== state.currentUser.uid) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unreadCount++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, { onlyOnce: true });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  resolve({ lastMessage: await lastMessage, messageTimestamp, unreadCount });
Â  Â  Â  Â  }, { onlyOnce: true });
Â  Â  Â  });
Â  Â  }

Â  Â  function appendFriendCard(friend) {
Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  div.className = 'friend-card';
Â  Â  Â  const avatarContent = friend.photoURL
Â  Â  Â  Â  ? `<img src="${friend.photoURL}" alt="${friend.displayName}'s profile">`
Â  Â  Â  Â  : `<div class="avatar">${friend.displayName[0].toUpperCase()}</div>`;
Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  ${avatarContent}
Â  Â  Â  Â  <div class="friend-info">
Â  Â  Â  Â  Â  <h3>${friend.displayName}</h3>
Â  Â  Â  Â  Â  <span class="last-seen">${friend.lastSeen}</span>
Â  Â  Â  Â  Â  <p>${friend.lastMessage}</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <span class="timestamp">
Â  Â  Â  Â  Â  ${friend.messageTimestamp ? new Date(friend.messageTimestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ''}
Â  Â  Â  Â  Â  ${friend.unreadCount > 0 ? `<span class="unread-count">${friend.unreadCount}</span>` : ''}
Â  Â  Â  Â  </span>
Â  Â  Â  `;
Â  Â  Â  div.addEventListener('click', () => {
Â  Â  Â  Â  window.location.href = `chat.html?friendId=${friend.uid}&friendName=${encodeURIComponent(friend.displayName)}`;
Â  Â  Â  });
Â  Â  Â  elements.chatsContent.appendChild(div);
Â  Â  }

Â  Â  async function loadStatuses() {
Â  Â  Â  elements.myStatus.innerHTML = '<h3 style="font-size: 1rem; color: #1E1E1E; margin-bottom: 0.5rem;">My Status</h3>';
Â  Â  Â  elements.friendsStatuses.innerHTML = '<h3 style="font-size: 1rem; color: #1E1E1E; margin-bottom: 0.5rem;">Friends\' Statuses</h3>';

Â  Â  Â  // Load current user's status
Â  Â  Â  const myStatusRef = ref(db, `statuses/${state.currentUser.uid}`);
Â  Â  Â  onValue(myStatusRef, (snapshot) => {
Â  Â  Â  Â  elements.myStatus.innerHTML = '<h3 style="font-size: 1rem; color: #1E1E1E; margin-bottom: 0.5rem;">My Status</h3>';
Â  Â  Â  Â  if (snapshot.exists()) {
Â  Â  Â  Â  Â  const statuses = snapshot.val();
Â  Â  Â  Â  Â  for (const statusId in statuses) {
Â  Â  Â  Â  Â  Â  const status = statuses[statusId];
Â  Â  Â  Â  Â  Â  if (new Date().getTime() - status.timestamp < 24 * 60 * 60 * 1000) {
Â  Â  Â  Â  Â  Â  Â  appendStatusCard(state.currentUser.uid, state.currentUser.displayName || 'Me', status, statusId);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  elements.myStatus.innerHTML += '<p style="font-size: 0.875rem; color: var(--text-secondary); opacity: 0.8;">No status yet. Add one above!</p>';
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // Load friends' statuses
Â  Â  Â  const friendsRef = ref(db, `users/${state.currentUser.uid}/friends`);
Â  Â  Â  onValue(friendsRef, async (snapshot) => {
Â  Â  Â  Â  elements.friendsStatuses.innerHTML = '<h3 style="font-size: 1rem; color: #1E1E1E; margin-bottom: 0.5rem;">Friends\' Statuses</h3>';
Â  Â  Â  Â  if (snapshot.exists()) {
Â  Â  Â  Â  Â  const friends = snapshot.val();
Â  Â  Â  Â  Â  for (const friendUid in friends) {
Â  Â  Â  Â  Â  Â  const statusRef = ref(db, `statuses/${friendUid}`);
Â  Â  Â  Â  Â  Â  const statusSnapshot = await new Promise(resolve => onValue(statusRef, resolve, { onlyOnce: true }));
Â  Â  Â  Â  Â  Â  if (statusSnapshot.exists()) {
Â  Â  Â  Â  Â  Â  Â  const statuses = statusSnapshot.val();
Â  Â  Â  Â  Â  Â  Â  for (const statusId in statuses) {
Â  Â  Â  Â  Â  Â  Â  Â  const status = statuses[statusId];
Â  Â  Â  Â  Â  Â  Â  Â  if (new Date().getTime() - status.timestamp < 24 * 60 * 60 * 1000) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  appendStatusCard(friendUid, friends[friendUid].displayName, status, statusId);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  elements.friendsStatuses.innerHTML += '<p style="font-size: 0.875rem; color: var(--text-secondary); opacity: 0.8;">No friends\' statuses yet.</p>';
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  function appendStatusCard(uid, displayName, status, statusId) {
Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  div.className = 'status-card';
Â  Â  Â  const avatarContent = state.friends.find(f => f.uid === uid)?.photoURL || (uid === state.currentUser.uid && state.currentUser.photoURL)
Â  Â  Â  Â  ? `<img src="${state.friends.find(f => f.uid === uid)?.photoURL || state.currentUser.photoURL}" alt="${displayName}'s profile">`
Â  Â  Â  Â  : `<div class="avatar">${displayName[0].toUpperCase()}</div>`;
Â  Â  Â  const content = status.type === 'image'
Â  Â  Â  Â  ? `<img src="${status.content}" class="status-image" alt="Status image">`
Â  Â  Â  Â  : `<p>${status.content}</p>`;
Â  Â  Â  const viewerCount = status.viewers ? Object.keys(status.viewers).length : 0;
Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  ${avatarContent}
Â  Â  Â  Â  <div class="status-info">
Â  Â  Â  Â  Â  <h3>${displayName}</h3>
Â  Â  Â  Â  Â  <span class="last-seen">${new Date(status.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
Â  Â  Â  Â  Â  ${content}
Â  Â  Â  Â  Â  <span class="status-viewer-count">${viewerCount} view${viewerCount === 1 ? '' : 's'}</span>
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  Â  div.addEventListener('click', () => viewStatus(uid, displayName, status, statusId));
Â  Â  Â  if (uid === state.currentUser.uid) {
Â  Â  Â  Â  elements.myStatus.appendChild(div);
Â  Â  Â  } else {
Â  Â  Â  Â  elements.friendsStatuses.appendChild(div);
Â  Â  Â  }
Â  Â  }

Â  Â  async function viewStatus(uid, displayName, status, statusId) {
Â  Â  Â  if (uid !== state.currentUser.uid) {
Â  Â  Â  Â  const viewerRef = ref(db, `statuses/${uid}/${statusId}/viewers/${state.currentUser.uid}`);
Â  Â  Â  Â  await set(viewerRef, true);
Â  Â  Â  }
Â  Â  Â  elements.statusViewerContent.innerHTML = `
Â  Â  Â  Â  <h3 style="color: var(--text-primary);">${displayName}</h3>
Â  Â  Â  Â  ${status.type === 'image' ? `<img src="${status.content}" alt="Status image">` : `<p>${status.content}</p>`}
Â  Â  Â  Â  <span style="color: var(--text-primary); font-size: 0.75rem;">${new Date(status.timestamp).toLocaleString()}</span>
Â  Â  Â  `;
Â  Â  Â  elements.statusViewerOverlay.classList.add('open');
Â  Â  }

Â  Â  async function uploadStatus() {
Â  Â  Â  const text = elements.statusInput.value.trim();
Â  Â  Â  if (!text && !elements.statusImageInput.files[0]) {
Â  Â  Â  Â  alert('Please enter a status or select an image.');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  const statusId = Date.now().toString();
Â  Â  Â  const statusRef = ref(db, `statuses/${state.currentUser.uid}/${statusId}`);
Â  Â  Â  if (elements.statusImageInput.files[0]) {
Â  Â  Â  Â  const file = elements.statusImageInput.files[0];
Â  Â  Â  Â  const storagePath = `statuses/${state.currentUser.uid}/${statusId}`;
Â  Â  Â  Â  const fileRef = storageRef(storage, storagePath);
Â  Â  Â  Â  await uploadBytes(fileRef, file);
Â  Â  Â  Â  const url = await getDownloadURL(fileRef);
Â  Â  Â  Â  await set(statusRef, {
Â  Â  Â  Â  Â  type: 'image',
Â  Â  Â  Â  Â  content: url,
Â  Â  Â  Â  Â  timestamp: serverTimestamp(),
Â  Â  Â  Â  Â  viewers: {}
Â  Â  Â  Â  });
Â  Â  Â  } else {
Â  Â  Â  Â  await set(statusRef, {
Â  Â  Â  Â  Â  type: 'text',
Â  Â  Â  Â  Â  content: text,
Â  Â  Â  Â  Â  timestamp: serverTimestamp(),
Â  Â  Â  Â  Â  viewers: {}
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â  elements.statusInput.value = '';
Â  Â  Â  elements.statusImageInput.value = '';
Â  Â  }

Â  Â  function setActiveTab(tabId) {
Â  Â  Â  // Hide all content sections and remove 'active' class from all tabs
Â  Â  Â  const contentSections = [elements.chatsContent, elements.statusContent, elements.callsContent];
Â  Â  Â  contentSections.forEach(section => section.classList.add('hidden'));

Â  Â  Â  const tabs = [elements.chatsTab, elements.statusTab, elements.callsTab];
Â  Â  Â  tabs.forEach(tab => tab.classList.remove('active'));

Â  Â  Â  // Show the selected content section and add 'active' class to the clicked tab
Â  Â  Â  const activeTab = document.getElementById(tabId);
Â  Â  Â  const targetContentId = activeTab.getAttribute('data-target');
Â  Â  Â  const activeContent = document.getElementById(targetContentId);

Â  Â  Â  activeTab.classList.add('active');
Â  Â  Â  activeContent.classList.remove('hidden');
Â  Â  }

Â  Â  elements.chatsTab.addEventListener('click', () => {
Â  Â  Â  setActiveTab('chats-tab');
Â  Â  });

Â  Â  elements.statusTab.addEventListener('click', () => {
Â  Â  Â  setActiveTab('status-tab');
Â  Â  });

Â  Â  elements.callsTab.addEventListener('click', () => {
Â  Â  Â  setActiveTab('calls-tab');
Â  Â  });

Â  Â  elements.hamburgerButton.addEventListener('click', () => {
Â  Â  Â  elements.sidebar.classList.add('open');
Â  Â  });

Â  Â  elements.closeSidebar.addEventListener('click', () => {
Â  Â  Â  elements.sidebar.classList.remove('open');
Â  Â  });

Â  Â  elements.addFriendButton.addEventListener('click', () => {
Â  Â  Â  window.location.href = 'add.html';
Â  Â  });

Â  Â  elements.statusUploadButton.addEventListener('click', uploadStatus);

Â  Â  elements.statusInput.addEventListener('keypress', (e) => {
Â  Â  Â  if (e.key === 'Enter') {
Â  Â  Â  Â  uploadStatus();
Â  Â  Â  }
Â  Â  });

Â  Â  elements.statusImageInput.addEventListener('change', () => {
Â  Â  Â  if (elements.statusImageInput.files[0]) {
Â  Â  Â  Â  uploadStatus();
Â  Â  Â  }
Â  Â  });

Â  Â  elements.statusViewerClose.addEventListener('click', () => {
Â  Â  Â  elements.statusViewerOverlay.classList.remove('open');
Â  Â  Â  elements.statusViewerContent.innerHTML = '';
Â  Â  });

Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  initializeFirebase();
Â  Â  Â  // Set the initial active tab on page load
Â  Â  Â  setActiveTab('chats-tab');
Â  Â  });
Â  </script>
</body>
</html>
