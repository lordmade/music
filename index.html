<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vynix Max • Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg: #000;
      --surface: #111;
      --surface-hover: #1a1a1a;
      --accent: #e50914;
      --accent-hover: #f40613;
      --text: #ffffff;
      --text-dim: #aaa;
      --border: rgba(255,255,255,0.08);
      --radius: 10px;
      --success: #22c55e;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, sans-serif;
      min-height: 100vh;
      padding: 2rem;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem; }
    h1 { font-size: 2.2rem; font-weight: 900; letter-spacing: -1px; }
    .btn {
      padding: 0.75rem 1.6rem;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.25s ease;
    }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); }
    .btn-danger { background: #c62828; color: white; }
    .btn-danger:hover { background: #d32f2f; }
    .btn-success { background: var(--success); color: white; }
    .section { background: var(--surface); border-radius: var(--radius); padding: 1.8rem; margin-bottom: 2rem; border: 1px solid var(--border); }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.4rem; }
    .section-title { font-size: 1.5rem; font-weight: 700; }
    .form-grid { display: grid; gap: 1.4rem; }
    .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
    label { font-weight: 600; font-size: 0.95rem; color: var(--text-dim); }
    input, textarea {
      padding: 0.9rem 1rem;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: white;
      font-size: 0.96rem;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(229,9,20,0.2);
    }
    .upload-area {
      border: 2px dashed var(--border);
      border-radius: 10px;
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      position: relative;
    }
    .upload-area:hover { border-color: var(--accent); background: rgba(229,9,20,0.05); }
    .upload-area input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    .preview { max-width: 100%; max-height: 180px; margin-top: 1rem; border-radius: 8px; display: none; }
    .progress-bar { height: 4px; background: var(--accent); width: 0%; transition: width 0.3s ease; margin-top: 0.8rem; border-radius: 2px; }
    .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.4rem; margin-top: 1.5rem; }
    .item-card {
      background: rgba(255,255,255,0.04);
      border-radius: 10px;
      overflow: hidden;
      transition: all 0.25s ease;
      position: relative;
      cursor: grab;
      user-select: none;
    }
    .item-card:hover { transform: translateY(-6px); box-shadow: 0 12px 30px rgba(0,0,0,0.5); }
    .item-card img { width: 100%; aspect-ratio: 16 / 9; object-fit: cover; }
    .item-info { padding: 1rem; text-align: center; }
    .item-title { font-weight: 600; margin-bottom: 0.4rem; font-size: 1.1rem; }
    .item-year { color: var(--text-dim); font-size: 0.9rem; }
    .item-actions { display: flex; justify-content: center; gap: 0.6rem; padding: 0.8rem 1rem; }
    .drag-handle {
      position: absolute;
      top: 8px; left: 8px;
      background: rgba(0,0,0,0.6);
      color: white;
      border-radius: 50%;
      width: 32px; height: 32px;
      display: flex; align-items: center; justify-content: center;
      cursor: grab;
      z-index: 10;
    }
    .login-container { max-width: 420px; margin: 8rem auto; background: var(--surface); padding: 2.5rem; border-radius: var(--radius); border: 1px solid var(--border); }
    .hidden { display: none !important; }
    .sortable-ghost { opacity: 0.4; background: rgba(229,9,20,0.2); }
    .sortable-chosen { box-shadow: 0 10px 30px rgba(229,9,20,0.4); }

    /* Modal */
    #editModal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.8);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: var(--surface);
      border-radius: var(--radius);
      width: 90%; max-width: 520px;
      padding: 2rem;
      border: 1px solid var(--border);
    }
    .toast {
      position: fixed; bottom: 24px; left: 50%;
      transform: translateX(-50%);
      background: #333; color: white;
      padding: 1rem 2rem;
      border-radius: 8px;
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.4s;
      box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>

<div id="loginPage" class="login-container">
  <h1 style="text-align:center; margin-bottom:2rem;">Vynix Max Dashboard</h1>
  <div class="form-group"><label>Email</label><input type="email" id="email" placeholder="admin@vynixmax.com"/></div>
  <div class="form-group" style="margin:1.2rem 0;"><label>Password</label><input type="password" id="password" placeholder="••••••••"/></div>
  <button class="btn btn-primary" style="width:100%;" id="loginBtn">Login</button>
  <p id="loginError" style="color:#ff5252; margin-top:1rem; text-align:center;"></p>
</div>

<div id="dashboard" class="container hidden">
  <header>
    <h1>Vynix Max Admin</h1>
    <button class="btn btn-danger" id="signOutBtn">Sign Out</button>
  </header>

  <!-- Hero Section -->
  <div class="section">
    <div class="section-header"><div class="section-title">Hero Section</div></div>
    <div class="form-grid">
      <div class="form-group"><label>Title</label><input type="text" id="heroTitle"/></div>
      <div class="form-group"><label>Description</label><textarea id="heroDescription"></textarea></div>
      <div class="form-group"><label>Badge</label><input type="text" id="heroBadge" placeholder="16+"/></div>
      <div class="form-group"><label>Rating</label><input type="text" id="heroRating"/></div>
      <div class="form-group"><label>Year</label><input type="text" id="heroYear"/></div>
      <div class="form-group"><label>Duration</label><input type="text" id="heroDuration"/></div>
      <div class="form-group" style="grid-column: span 2;">
        <label>Background (Image/Video)</label>
        <div class="upload-area" id="heroUploadArea">
          <span>Click or drag & drop</span>
          <input type="file" id="heroFileInput" accept="image/*,video/*"/>
          <img id="heroPreview" class="preview"/>
          <div id="heroProgress" class="progress-bar"></div>
        </div>
      </div>
    </div>
    <button class="btn btn-primary" style="margin-top:1.5rem;" id="saveHero">Save Hero</button>
  </div>

  <!-- Movie Sections (New, Trending, Popular) -->
  <div class="section">
    <div class="section-header"><div class="section-title">New Releases</div><button class="btn btn-primary" id="toggleNewForm">+ Add</button></div>
    <div id="newReleaseForm" class="form-grid hidden">
      <div class="form-group"><label>Title</label><input type="text" id="newTitle"/></div>
      <div class="form-group"><label>Year</label><input type="text" id="newYear"/></div>
      <div class="form-group" style="grid-column: span 2;">
        <label>Poster</label>
        <div class="upload-area" id="newUploadArea"><span>Click or drag</span><input type="file" id="newFileInput" accept="image/*,video/*"/><img id="newPreview" class="preview"/><div id="newProgress" class="progress-bar"></div></div>
      </div>
      <button class="btn btn-primary" id="saveNewRelease">Save Movie</button>
    </div>
    <div class="items-grid sortable" id="newReleasesList" data-category="new"></div>
  </div>

  <!-- Similar structure for Trending and Popular - omitted for brevity, copy the pattern -->

  <!-- Edit Modal -->
  <div id="editModal" class="hidden">
    <div class="modal-content">
      <h2>Edit Movie</h2>
      <div class="form-grid" style="margin:1.5rem 0;">
        <div class="form-group"><label>Category</label><input type="text" id="editCategory" readonly/></div>
        <div class="form-group"><label>Title</label><input type="text" id="editTitle"/></div>
        <div class="form-group"><label>Year</label><input type="text" id="editYear"/></div>
        <div class="form-group" style="grid-column:span 2">
          <label>Poster (optional)</label>
          <div class="upload-area" id="editUploadArea">
            <span>Click or drag to replace</span>
            <input type="file" id="editFileInput" accept="image/*"/>
            <img id="editPreview" class="preview"/>
            <div id="editProgress" class="progress-bar"></div>
          </div>
          <div style="margin-top:0.6rem;">
            <button type="button" class="btn btn-danger" id="removeImageBtn" style="font-size:0.85rem; padding:0.4rem 0.9rem;">Remove Image</button>
            <small id="editCurrentImageText" style="color:var(--text-dim); margin-left:1rem;"></small>
          </div>
        </div>
      </div>
      <div style="display:flex; gap:1rem; justify-content:flex-end;">
        <button class="btn" id="cancelEdit">Cancel</button>
        <button class="btn btn-danger" id="deleteEditBtn">Delete</button>
        <button class="btn btn-primary" id="saveEditBtn">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Simple toast notification -->
  <div id="toast" class="toast"></div>
</div>

<script>
// ────────────────────────────────────────────────
// CONFIG & STATE
// ────────────────────────────────────────────────
const CLOUD_NAME = "dqkujefxj";
const UPLOAD_PRESET = "banter_box";

const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.appspot.com",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let currentEditingKey = null;
let currentEditingCategory = null;
let originalImageUrl = null;

// ────────────────────────────────────────────────
// HELPERS
// ────────────────────────────────────────────────
function showToast(message, duration = 3000) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), duration);
}

function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// ────────────────────────────────────────────────
// AUTH
// ────────────────────────────────────────────────
auth.onAuthStateChanged(user => {
  document.getElementById('loginPage').classList.toggle('hidden', !!user);
  document.getElementById('dashboard').classList.toggle('hidden', !user);
  if (user) loadAllContent();
});

document.getElementById('loginBtn').onclick = async () => {
  try {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    await auth.signInWithEmailAndPassword(email, password);
  } catch (err) {
    document.getElementById('loginError').textContent = err.message;
  }
};

document.getElementById('signOutBtn').onclick = () => auth.signOut();

// ────────────────────────────────────────────────
// CLOUDINARY UPLOAD
// ────────────────────────────────────────────────
async function uploadToCloudinary(file, progressId) {
  return new Promise((resolve, reject) => {
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", UPLOAD_PRESET);

    const xhr = new XMLHttpRequest();
    xhr.open("POST", `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`);
    
    xhr.upload.onprogress = e => {
      if (e.lengthComputable) {
        document.getElementById(progressId).style.width = `${(e.loaded / e.total) * 100}%`;
      }
    };

    xhr.onload = () => {
      if (xhr.status === 200) {
        const data = JSON.parse(xhr.responseText);
        resolve(data.secure_url);
      } else {
        reject(new Error("Upload failed"));
      }
    };

    xhr.onerror = () => reject(new Error("Network error"));
    xhr.send(formData);
  });
}

// ────────────────────────────────────────────────
// FILE UPLOAD SETUP
// ────────────────────────────────────────────────
function setupUpload(areaId, inputId, previewId, progressId) {
  const area = document.getElementById(areaId);
  const input = document.getElementById(inputId);
  const preview = document.getElementById(previewId);
  const progress = document.getElementById(progressId);

  const handleFile = async (file) => {
    if (!file) return;
    progress.style.width = '0%';
    preview.src = URL.createObjectURL(file);
    preview.style.display = 'block';
    try {
      const url = await uploadToCloudinary(file, progressId);
      preview.dataset.cloudinaryUrl = url;
      progress.style.width = '100%';
    } catch (e) {
      showToast("Upload failed: " + e.message, 4000);
      progress.style.width = '0%';
    }
  };

  area.onclick = () => input.click();
  area.addEventListener('drop', e => {
    e.preventDefault();
    if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
  });
  ['dragenter','dragover'].forEach(e => area.addEventListener(e, ev => ev.preventDefault()));
  input.onchange = e => handleFile(e.target.files[0]);
}

// Setup all upload zones
['hero','new','trending','popular','edit'].forEach(prefix => {
  setupUpload(
    `${prefix}UploadArea`,
    `${prefix}FileInput`,
    `${prefix}Preview`,
    `${prefix}Progress`
  );
});

// ────────────────────────────────────────────────
// SAVE HERO
// ────────────────────────────────────────────────
document.getElementById("saveHero").onclick = async function() {
  this.disabled = true;
  this.textContent = "Saving...";

  try {
    const updates = {
      title: document.getElementById("heroTitle").value.trim(),
      description: document.getElementById("heroDescription").value.trim(),
      badge: document.getElementById("heroBadge").value.trim() || "16+",
      rating: document.getElementById("heroRating").value.trim(),
      year: document.getElementById("heroYear").value.trim(),
      duration: document.getElementById("heroDuration").value.trim(),
      backgroundImage: document.getElementById("heroPreview").dataset.cloudinaryUrl || null,
      updatedAt: firebase.database.ServerValue.TIMESTAMP
    };
    await db.ref("/content/hero").update(updates);
    showToast("Hero section saved successfully!");
  } catch (err) {
    showToast("Error saving hero: " + err.message, 5000);
  } finally {
    this.disabled = false;
    this.textContent = "Save Hero";
  }
};

// ────────────────────────────────────────────────
// ADD NEW MOVIE (generic)
// ────────────────────────────────────────────────
async function addNewMovie(category) {
  const titleEl = document.getElementById(`${category}Title`);
  const yearEl = document.getElementById(`${category}Year`);
  const preview = document.getElementById(`${category}Preview`);

  const title = titleEl.value.trim();
  const year = yearEl.value.trim();
  const image = preview.dataset.cloudinaryUrl;

  if (!title || !year) {
    showToast("Title and Year are required!");
    return;
  }

  try {
    const snap = await db.ref(`/content/${category}`).orderByChild("order").limitToLast(1).once("value");
    let maxOrder = 0;
    snap.forEach(c => { maxOrder = c.val().order || 0; });

    await db.ref(`/content/${category}`).push({
      title, year,
      image: image || null,
      order: maxOrder + 100,
      createdAt: firebase.database.ServerValue.TIMESTAMP
    });

    titleEl.value = yearEl.value = "";
    preview.src = preview.style.display = preview.dataset.cloudinaryUrl = "";
    showToast(`Added to ${category}!`);
  } catch (err) {
    showToast("Failed to add movie", 4000);
  }
}

document.getElementById("saveNewRelease").onclick = () => addNewMovie("new");
// Add similar .onclick handlers for trending & popular...

// ────────────────────────────────────────────────
// EDIT MODAL LOGIC
// ────────────────────────────────────────────────
function openEditModal(category, key, title, year, image = '') {
  currentEditingKey = key;
  currentEditingCategory = category;
  originalImageUrl = image;

  document.getElementById('editCategory').value = category.charAt(0).toUpperCase() + category.slice(1);
  document.getElementById('editTitle').value = title;
  document.getElementById('editYear').value = year;

  const preview = document.getElementById('editPreview');
  const currentText = document.getElementById('editCurrentImageText');

  preview.src = '';
  preview.style.display = 'none';
  preview.dataset.cloudinaryUrl = '';
  document.getElementById('editProgress').style.width = '0%';

  if (image && !image.includes('placeholder')) {
    preview.src = image;
    preview.style.display = 'block';
    currentText.textContent = 'Current image loaded';
  } else {
    currentText.textContent = 'No image';
  }

  document.getElementById('editModal').classList.remove('hidden');
}

async function saveEdit() {
  if (!currentEditingKey) return;

  const btn = document.getElementById('saveEditBtn');
  btn.disabled = true;
  btn.textContent = "Saving...";

  try {
    const title = document.getElementById('editTitle').value.trim();
    const year = document.getElementById('editYear').value.trim();
    const newImage = document.getElementById('editPreview').dataset.cloudinaryUrl;

    if (!title || !year) throw new Error("Title and Year required");

    const updates = { title, year, updatedAt: firebase.database.ServerValue.TIMESTAMP };
    if (newImage) updates.image = newImage;

    await db.ref(`/content/${currentEditingCategory}/${currentEditingKey}`).update(updates);
    showToast("Movie updated!");
    closeEditModal();
  } catch (err) {
    showToast("Save failed: " + err.message, 5000);
  } finally {
    btn.disabled = false;
    btn.textContent = "Save Changes";
  }
}

function closeEditModal() {
  document.getElementById('editModal').classList.add('hidden');
  currentEditingKey = currentEditingCategory = originalImageUrl = null;
}

// Event listeners for modal
document.getElementById('saveEditBtn').onclick = saveEdit;
document.getElementById('cancelEdit').onclick = closeEditModal;
document.getElementById('deleteEditBtn').onclick = async () => {
  if (confirm("Delete this movie permanently?")) {
    await db.ref(`/content/${currentEditingCategory}/${currentEditingKey}`).remove();
    showToast("Movie deleted");
    closeEditModal();
  }
};

document.getElementById('removeImageBtn').onclick = () => {
  const preview = document.getElementById('editPreview');
  preview.src = preview.style.display = preview.dataset.cloudinaryUrl = "";
  document.getElementById('editCurrentImageText').textContent = "Image will be removed";
};

document.getElementById('editModal').onclick = e => {
  if (e.target === e.currentTarget) closeEditModal();
};

// ────────────────────────────────────────────────
// RENDER MOVIES
// ────────────────────────────────────────────────
function renderMovies(containerId, items, category) {
  const container = document.getElementById(containerId);
  container.innerHTML = items.length === 0 ? 
    '<p style="grid-column:1/-1;text-align:center;color:var(--text-dim);">No movies yet</p>' : '';

  items.sort((a,b) => (a.order||0) - (b.order||0));

  items.forEach(item => {
    const card = document.createElement('div');
    card.className = 'item-card';
    card.dataset.key = item.key;
    card.dataset.category = category;

    card.innerHTML = `
      <div class="drag-handle"><span class="material-symbols-rounded">drag_handle</span></div>
      <img src="${item.image || 'https://via.placeholder.com/320x180?text=No+Poster'}" alt="${escapeHtml(item.title)}"/>
      <div class="item-info">
        <div class="item-title">${escapeHtml(item.title)}</div>
        <div class="item-year">${item.year}</div>
      </div>
      <div class="item-actions">
        <button class="btn btn-primary edit-btn" style="padding:0.4rem 1rem;font-size:0.85rem;">Edit</button>
        <button class="btn btn-danger delete-btn" style="padding:0.4rem 1rem;font-size:0.85rem;">Delete</button>
      </div>
    `;

    card.querySelector('.edit-btn').onclick = (e) => {
      e.stopPropagation();
      openEditModal(category, item.key, item.title, item.year, item.image||'');
    };

    card.querySelector('.delete-btn').onclick = (e) => {
      e.stopPropagation();
      if (confirm(`Delete "${item.title}"?`)) {
        db.ref(`/content/${category}/${item.key}`).remove();
      }
    };

    card.onclick = (e) => {
      if (!e.target.closest('button') && !e.target.closest('.drag-handle')) {
        openEditModal(category, item.key, item.title, item.year, item.image||'');
      }
    };

    container.appendChild(card);
  });

  new Sortable(container, {
    animation: 180,
    handle: '.drag-handle',
    ghostClass: 'sortable-ghost',
    chosenClass: 'sortable-chosen',
    onEnd: () => {
      const updates = {};
      Array.from(container.children).forEach((el, i) => {
        const key = el.dataset.key;
        if (key) updates[`${key}/order`] = (i + 1) * 100;
      });
      if (Object.keys(updates).length) {
        db.ref(`/content/${category}`).update(updates);
      }
    }
  });
}

// ────────────────────────────────────────────────
// LOAD DATA
// ────────────────────────────────────────────────
function loadAllContent() {
  // Hero
  db.ref("/content/hero").on("value", snap => {
    const data = snap.val() || {};
    Object.entries({
      heroTitle: 'title',
      heroDescription: 'description',
      heroBadge: 'badge',
      heroRating: 'rating',
      heroYear: 'year',
      heroDuration: 'duration'
    }).forEach(([id, key]) => {
      document.getElementById(id).value = data[key] || '';
    });
    if (data.backgroundImage) {
      const p = document.getElementById('heroPreview');
      p.src = data.backgroundImage;
      p.style.display = 'block';
      p.dataset.cloudinaryUrl = data.backgroundImage;
    }
  });

  // Movie lists
  ['new', 'trending', 'popular'].forEach(cat => {
    db.ref(`/content/${cat}`).on("value", snap => {
      const movies = [];
      snap.forEach(child => movies.push({key: child.key, ...child.val()}));
      renderMovies(`${cat}ReleasesList` || `${cat}List`, movies, cat); // adjust ID if needed
    });
  });
}

// Toggle add forms
document.querySelectorAll('[id$="Form"]').forEach(form => {
  const toggleId = 'toggle' + form.id.replace('Form','');
  document.getElementById(toggleId)?.addEventListener('click', () => form.classList.toggle('hidden'));
});

</script>
</body>
</html>
