<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vynix AI - Home</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #F7F7F8;
      --card-bg: #1C2526;
      --text-primary: #FFFFFF;
      --text-secondary: #4B5EAA;
      --border: #4A5568;
      --highlight: #38B2AC;
      --badge-bg: #EF4444;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text-secondary);
      min-height: 100vh;
      margin: 0;
      transition: background 0.3s ease;
    }

    .header {
      background: var(--card-bg);
      color: var(--text-primary);
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .logo {
      font-size: 28px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .search-bar {
      flex: 1;
      max-width: 500px;
      margin: 0 20px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 9999px;
      font-size: 16px;
      outline: none;
      background: var(--bg);
      color: var(--text-secondary);
    }

    .search-input::placeholder {
      color: rgba(0, 0, 0, 0.5);
    }

    .header-icons {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .header-icons svg {
      width: 20px;
      height: 20px;
      stroke: var(--text-primary);
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      transition: background-color 0.3s;
    }

    .header-icons svg:hover {
      background-color: rgba(255,255,255,0.1);
    }

    .main-container {
      display: flex;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      gap: 20px;
    }

    .sidebar-left {
      width: 300px;
      flex-shrink: 0;
    }

    .feed {
      flex: 1;
      max-width: 500px;
    }

    .sidebar-right {
      width: 300px;
      flex-shrink: 0;
    }

    .create-post {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .post-profile {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .post-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
      font-weight: 600;
    }

    .post-profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .post-input {
      flex: 1;
      border: none;
      background: var(--bg);
      border-radius: 20px;
      padding: 10px 15px;
      outline: none;
      resize: none;
      color: var(--text-secondary);
    }

    .post-actions {
      display: flex;
      justify-content: space-around;
      border-top: 1px solid var(--border);
      padding-top: 10px;
    }

    .post-action {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
      color: var(--text-primary);
    }

    .post-action:hover {
      background-color: var(--highlight);
    }

    .post-action svg {
      width: 16px;
      height: 16px;
      stroke: var(--text-primary);
    }

    .post {
      background: var(--card-bg);
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .post-header {
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .post-header .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
      font-weight: 600;
    }

    .post-header .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .post-header-info {
      flex: 1;
    }

    .post-header-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .post-header-time {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
    }

    .post-content {
      padding: 0 15px 15px;
    }

    .post-text {
      margin-bottom: 10px;
      line-height: 1.4;
      color: var(--text-primary);
    }

    .post-image {
      width: 100%;
      max-height: 400px;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    .post-actions-bar {
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
    }

    .action-btn {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
      flex: 1;
      text-align: center;
      border: none;
      background: none;
      color: var(--text-primary);
    }

    .action-btn:hover {
      background-color: var(--highlight);
    }

    .action-btn.liked {
      color: var(--badge-bg);
    }

    .action-btn svg {
      width: 16px;
      height: 16px;
      stroke: var(--text-primary);
    }

    .action-btn.liked svg {
      stroke: var(--badge-bg);
      fill: var(--badge-bg);
    }

    .comments {
      padding: 0 15px 15px;
    }

    .comment {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      padding: 10px 0;
      border-top: 1px solid var(--border);
    }

    .comment-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
      font-weight: 600;
    }

    .comment-profile-pic {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }

    .comment-content {
      flex: 1;
    }

    .comment-header {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 2px;
    }

    .comment-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
    }

    .comment-time {
      color: rgba(255, 255, 255, 0.7);
      font-size: 12px;
    }

    .comment-text {
      font-size: 14px;
      color: var(--text-primary);
    }

    .sidebar-section {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .sidebar-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    .sidebar-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .sidebar-item:hover {
      background-color: var(--highlight);
      border-radius: 5px;
      padding-left: 5px;
    }

    .sidebar-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
      font-weight: 600;
    }

    .sidebar-profile-pic {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }

    .friends-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .story {
      background: var(--card-bg);
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .story-header {
      padding: 10px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .story-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
      font-weight: bold;
    }

    .story-add {
      border: 2px dashed var(--highlight);
      color: var(--highlight);
      background: var(--card-bg);
    }

    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }

    .spinner-overlay.active {
      display: flex;
    }

    .spinner {
      width: 100px;
      height: 4px;
      background: var(--highlight);
      border-radius: 2px;
      animation: loading 1.5s ease-in-out infinite;
    }

    @keyframes loading {
      0% { transform: scaleX(0); transform-origin: left; }
      50% { transform: scaleX(1); transform-origin: left; }
      51% { transform-origin: right; }
      100% { transform: scaleX(0); transform-origin: right; }
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .post, .story {
      animation: slideIn 0.3s ease-out;
    }

    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
        padding: 10px;
      }

      .sidebar-left, .sidebar-right {
        width: 100%;
        order: 3;
      }

      .feed {
        order: 2;
      }

      .header {
        padding: 10px;
      }

      .search-bar {
        margin: 0 10px;
      }
    }
  </style>
</head>
<body>
  <main class="flex flex-col h-screen" id="main-content">
    <div class="header">
      <div class="logo">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
        </svg>
        <span>Vynix AI</span>
      </div>
      <div class="search-bar">
        <input type="text" id="search-input" class="search-input" placeholder="Search Vynix AI">
      </div>
      <div class="header-icons">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" class="active" onclick="window.location.href='index.html'">
          <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
        </svg>
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" onclick="window.location.href='friends.html'" id="friends-nav">
          <path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
        </svg>
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" onclick="window.location.href='profile.html'">
          <path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
        </svg>
      </div>
    </div>

    <div class="main-container">
      <aside class="sidebar-left">
        <div class="sidebar-section">
          <div class="sidebar-title">Stories</div>
          <div class="story">
            <div class="story-header">
              <div class="story-avatar story-add">+ Add</div>
              <div>
                <div style="font-weight: 600;">Create a story</div>
                <div style="color: rgba(255,255,255,0.7); font-size: 14px;">Share a photo or write something</div>
              </div>
            </div>
          </div>
          <div class="friends-list" id="stories-list"></div>
        </div>
      </aside>

      <section class="feed">
        <div class="create-post">
          <div class="post-profile">
            <div id="user-avatar" class="post-avatar"></div>
            <textarea id="post-input" class="post-input" placeholder="What's on your mind?"></textarea>
          </div>
          <div class="post-actions">
            <div class="post-action">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
              </svg>
              <span>Video</span>
            </div>
            <div class="post-action">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              <span>Photo</span>
            </div>
          </div>
        </div>
        <div id="posts-list"></div>
      </section>

      <aside class="sidebar-right">
        <div class="sidebar-section">
          <div class="sidebar-title">Contacts</div>
          <div class="friends-list" id="contacts-list"></div>
        </div>
      </aside>

      <div id="spinner-overlay" class="spinner-overlay">
        <div class="spinner"></div>
      </div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, onValue, push, update } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    let app, auth, db, currentUser;
    const encryptionKey = new TextEncoder().encode('vynix-ai-secret-key-32bytes123456');

    const showSpinner = () => {
      document.getElementById('spinner-overlay').classList.add('active');
      document.getElementById('main-content').setAttribute('aria-busy', 'true');
    };

    const hideSpinner = () => {
      document.getElementById('spinner-overlay').classList.remove('active');
      document.getElementById('main-content').setAttribute('aria-busy', 'false');
    };

    async function encryptMessage(message) {
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const encrypted = await crypto.subtle.encrypt(
        { name: 'AES-GCM', iv },
        await crypto.subtle.importKey('raw', encryptionKey, 'AES-GCM', false, ['encrypt']),
        new TextEncoder().encode(message)
      );
      const encryptedArray = new Uint8Array(encrypted);
      return { iv: Array.from(iv), data: Array.from(encryptedArray) };
    }

    async function decryptMessage(encryptedData, iv) {
      try {
        const decrypted = await crypto.subtle.decrypt(
          { name: 'AES-GCM', iv: new Uint8Array(iv) },
          await crypto.subtle.importKey('raw', encryptionKey, 'AES-GCM', false, ['decrypt']),
          new Uint8Array(encryptedData)
        );
        return new TextDecoder().decode(decrypted);
      } catch (error) {
        console.error('Decryption Error:', error);
        return '[Encrypted Message]';
      }
    }

    function initializeFirebase() {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getDatabase(app);
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          update(ref(db, `users/${user.uid}`), { lastSeen: new Date().toISOString() });
          document.getElementById('user-avatar').innerHTML = user.photoURL
            ? `<img src="${user.photoURL}" class="post-profile-pic" alt="${user.displayName}'s profile picture">`
            : user.displayName ? user.displayName[0].toUpperCase() : 'U';
          loadStories();
          loadPosts();
          loadContacts();
          loadUnreadMessages();
        } else {
          window.location.href = 'signup.html';
        }
      });
    }

    async function loadStories() {
      showSpinner();
      const storiesRef = ref(db, 'users');
      try {
        onValue(storiesRef, (snapshot) => {
          const storiesList = document.getElementById('stories-list');
          storiesList.innerHTML = '';
          const users = snapshot.val();
          if (!users) {
            hideSpinner();
            return;
          }
          Object.entries(users).forEach(([userId, userData]) => {
            if (userData.stories) {
              Object.entries(userData.stories).forEach(([_, story]) => {
                const div = document.createElement('div');
                div.className = 'story';
                div.innerHTML = `
                  <div class="story-header">
                    ${userData.photoURL
                      ? `<img src="${userData.photoURL}" class="story-avatar" alt="${userData.displayName}'s profile picture">`
                      : `<div class="story-avatar">${userData.displayName ? userData.displayName[0].toUpperCase() : 'U'}</div>`}
                    <div>
                      <div style="font-weight: 600;">${userData.displayName || 'User'}</div>
                      <div style="color: rgba(255,255,255,0.7); font-size: 14px;">${story.timestamp || 'New story'}</div>
                    </div>
                  </div>
                `;
                storiesList.appendChild(div);
              });
            }
          });
          hideSpinner();
        }, { onlyOnce: true });
      } catch (error) {
        console.error('Error loading stories:', error);
        hideSpinner();
      }
    }

    async function loadPosts() {
      showSpinner();
      const postsRef = ref(db, 'posts');
      try {
        onValue(postsRef, async (snapshot) => {
          const postsList = document.getElementById('posts-list');
          postsList.innerHTML = '';
          const posts = snapshot.val();
          if (!posts) {
            hideSpinner();
            return;
          }
          const postsArray = Object.entries(posts)
            .map(([postId, postData]) => ({ postId, ...postData }))
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          for (const post of postsArray) {
            const userRef = ref(db, `users/${post.userId}`);
            onValue(userRef, async (userSnapshot) => {
              const userData = userSnapshot.val();
              const postText = post.contentEncrypted
                ? await decryptMessage(post.contentEncrypted.data, post.contentEncrypted.iv)
                : post.content || '';
              const div = document.createElement('article');
              div.className = 'post';
              div.innerHTML = `
                <div class="post-header">
                  ${userData?.photoURL
                    ? `<img src="${userData.photoURL}" class="profile-pic" alt="${userData.displayName}'s profile picture">`
                    : `<div class="avatar">${userData?.displayName ? userData.displayName[0].toUpperCase() : 'U'}</div>`}
                  <div class="post-header-info">
                    <div class="post-header-name">${userData?.displayName || 'User'}</div>
                    <div class="post-header-time">${post.timestamp ? new Date(post.timestamp).toLocaleString() : ''}</div>
                  </div>
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" style="margin-left: auto;">
                    <path d="M12 5v.01M12 12v.01M12 19v.01"/>
                  </svg>
                </div>
                <div class="post-content">
                  <div class="post-text">${postText.slice(0, 200)}${postText.length > 200 ? '...' : ''}</div>
                  ${post.imageURL ? `<img src="${post.imageURL}" class="post-image" alt="Post image">` : ''}
                </div>
                <div class="post-actions-bar">
                  <button class="action-btn ${post.likedBy?.[currentUser.uid] ? 'liked' : ''}" onclick="toggleLike('${post.postId}', this)">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                      <path d="M7 22h1V9H5a3 3 0 003 3h2l2-2 2 2h2a3 3 0 003-3h-3V9h1"/>
                    </svg>
                    <span>${post.likedBy?.[currentUser.uid] ? 'Unlike' : 'Like'}</span>
                  </button>
                  <button class="action-btn">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                      <path d="M21 11.5a8.38 8.38 0 01-11.5 7 8.38 8.38 0 01-7-11.5 8.38 8.38 0 0111.5-7c3.1 1.1 5 4 5 7.5z"/>
                    </svg>
                    <span>Comment</span>
                  </button>
                  <button class="action-btn">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                      <path d="M15 15l6-6m0 0l-6-6m6 6H9a6 6 0 000 12h3"/>
                    </svg>
                    <span>Share</span>
                  </button>
                </div>
                <div class="comments">
                  ${post.comments ? Object.entries(post.comments).map(([_, comment]) => `
                    <div class="comment">
                      ${comment.userPhotoURL
                        ? `<img src="${comment.userPhotoURL}" class="comment-profile-pic" alt="${comment.userName}'s profile picture">`
                        : `<div class="comment-avatar">${comment.userName ? comment.userName[0].toUpperCase() : 'U'}</div>`}
                      <div class="comment-content">
                        <div class="comment-header">
                          <span class="comment-name">${comment.userName || 'User'}</span>
                          <span class="comment-time">${comment.timestamp ? new Date(comment.timestamp).toLocaleTimeString() : ''}</span>
                        </div>
                        <div class="comment-text">${comment.text.slice(0, 100)}${comment.text.length > 100 ? '...' : ''}</div>
                      </div>
                    </div>
                  `).join('') : ''}
                </div>
              `;
              postsList.appendChild(div);
            }, { onlyOnce: true });
          }
          hideSpinner();
        }, { onlyOnce: false });
      } catch (error) {
        console.error('Error loading posts:', error);
        hideSpinner();
      }
    }

    async function loadContacts() {
      showSpinner();
      const friendsRef = ref(db, `users/${currentUser.uid}/friends`);
      try {
        onValue(friendsRef, (snapshot) => {
          const contactsList = document.getElementById('contacts-list');
          contactsList.innerHTML = '';
          const friends = snapshot.val();
          if (!friends) {
            hideSpinner();
            return;
          }
          Object.entries(friends).forEach(([friendId, friendData]) => {
            const userRef = ref(db, `users/${friendId}`);
            onValue(userRef, (userSnapshot) => {
              const userData = userSnapshot.val();
              const div = document.createElement('div');
              div.className = 'sidebar-item';
              div.innerHTML = `
                ${userData?.photoURL
                  ? `<img src="${userData.photoURL}" class="sidebar-profile-pic" alt="${friendData.name}'s profile picture">`
                  : `<div class="sidebar-avatar">${friendData.name ? friendData.name[0].toUpperCase() : 'U'}</div>`}
                <div>
                  <div style="font-weight: 600;">${friendData.name || 'User'}</div>
                  <div style="color: rgba(255,255,255,0.7); font-size: 12px;">${userData?.lastSeen ? 'Active ' + new Date(userData.lastSeen).toLocaleTimeString() : ''}</div>
                </div>
              `;
              contactsList.appendChild(div);
            }, { onlyOnce: true });
          });
          hideSpinner();
        }, { onlyOnce: true });
      } catch (error) {
        console.error('Error loading contacts:', error);
        hideSpinner();
      }
    }

    function loadUnreadMessages() {
      const friendsRef = ref(db, `users/${currentUser.uid}/friends`);
      onValue(friendsRef, (snapshot) => {
        const friends = snapshot.val();
        let totalUnread = 0;
        if (friends) {
          Object.values(friends).forEach(friend => {
            totalUnread += friend.unreadCount || 0;
          });
        }
        const friendsNav = document.getElementById('friends-nav');
        friendsNav.querySelector('.unread-badge')?.remove();
        if (totalUnread > 0) {
          const badge = document.createElement('span');
          badge.className = 'unread-badge';
          badge.textContent = totalUnread;
          badge.style.cssText = 'background: var(--badge-bg); color: var(--text-primary); border-radius: 9999px; padding: 0.25rem 0.5rem; font-size: 0.75rem; position: absolute; top: -0.5rem; right: -0.5rem; min-width: 1.5rem; text-align: center;';
          friendsNav.appendChild(badge);
        }
      });
    }

    async function toggleLike(postId, button) {
      if (!currentUser) return;
      const postRef = ref(db, `posts/${postId}/likedBy/${currentUser.uid}`);
      const buttonIcon = button.querySelector('svg');
      const buttonText = button.querySelector('span');
      const isLiked = button.classList.contains('liked');
      try {
        await update(ref(db, `posts/${postId}/likedBy`), {
          [currentUser.uid]: isLiked ? null : true
        });
        button.classList.toggle('liked');
        buttonText.textContent = isLiked ? 'Like' : 'Unlike';
        if (isLiked) {
          buttonIcon.style.fill = 'none';
          buttonIcon.style.stroke = 'var(--text-primary)';
        } else {
          buttonIcon.style.fill = 'var(--badge-bg)';
          buttonIcon.style.stroke = 'var(--badge-bg)';
        }
      } catch (error) {
        console.error('Error toggling like:', error);
      }
    }

    async function createPost() {
      if (!currentUser) return;
      const content = document.getElementById('post-input').value.trim();
      if (!content) return;
      showSpinner();
      try {
        const encryptedContent = await encryptMessage(content);
        const postsRef = ref(db, 'posts');
        await push(postsRef, {
          userId: currentUser.uid,
          contentEncrypted: encryptedContent,
          timestamp: new Date().toISOString(),
          likedBy: {},
          comments: {}
        });
        document.getElementById('post-input').value = '';
        loadPosts();
      } catch (error) {
        console.error('Error creating post:', error);
        hideSpinner();
      }
    }

    document.getElementById('post-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        createPost();
      }
    });

    document.getElementById('search-input').addEventListener('input', (e) => {
      console.log('Searching for:', e.target.value);
      // Implement search functionality if needed
    });

    document.addEventListener('DOMContentLoaded', initializeFirebase);

    window.toggleLike = toggleLike;
  </script>
</body>
</html>
