<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vynix Max • Admin Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet"/>

  <!-- SortableJS for drag & drop -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <!-- Firebase Compat v9 -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <style>
    :root {
      --bg: #000;
      --surface: #111;
      --surface-hover: #1a1a1a;
      --accent: #e50914;
      --accent-hover: #f40613;
      --text: #ffffff;
      --text-dim: #aaa;
      --border: rgba(255,255,255,0.08);
      --radius: 10px;
      --transition: all 0.25s ease;
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, sans-serif;
      min-height: 100vh;
      padding: 2rem;
    }

    .container { max-width: 1200px; margin: 0 auto; }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2.5rem;
    }

    h1 { font-size: 2.2rem; font-weight: 900; letter-spacing: -1px; }

    .btn {
      padding: 0.75rem 1.6rem;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: var(--transition);
    }

    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); }

    .btn-danger { background: #c62828; color: white; }
    .btn-danger:hover { background: #d32f2f; }

    .section {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 1.8rem;
      margin-bottom: 2rem;
      border: 1px solid var(--border);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.4rem;
    }

    .section-title { font-size: 1.5rem; font-weight: 700; }

    .form-grid {
      display: grid;
      gap: 1.4rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    label {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-dim);
    }

    input, textarea {
      padding: 0.9rem 1rem;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: white;
      font-size: 0.96rem;
      transition: var(--transition);
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(229,9,20,0.2);
    }

    textarea { min-height: 90px; resize: vertical; }

    .file-upload {
      border: 2px dashed var(--border);
      border-radius: 10px;
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .file-upload:hover {
      border-color: var(--accent);
      background: rgba(229,9,20,0.05);
    }

    .preview {
      max-width: 100%;
      max-height: 180px;
      margin-top: 1rem;
      border-radius: 8px;
      display: none;
    }

    .items-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1.4rem;
      margin-top: 1.5rem;
      min-height: 100px;
    }

    .item-card {
      background: rgba(255,255,255,0.04);
      border-radius: 10px;
      overflow: hidden;
      transition: var(--transition);
      position: relative;
      cursor: grab;
      user-select: none;
    }

    .item-card:active { cursor: grabbing; }

    .item-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.5);
    }

    .item-card img, .item-card video {
      width: 100%;
      aspect-ratio: 16 / 9;
      object-fit: cover;
    }

    .item-info {
      padding: 1rem;
    }

    .item-title {
      font-weight: 600;
      margin-bottom: 0.4rem;
    }

    .item-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.6rem;
      padding: 0 1rem 1rem;
    }

    .drag-handle {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(0,0,0,0.6);
      color: white;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      cursor: grab;
      z-index: 10;
    }

    .login-container {
      max-width: 420px;
      margin: 8rem auto;
      background: var(--surface);
      padding: 2.5rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .hidden { display: none !important; }

    .sortable-ghost { opacity: 0.4; background: rgba(229,9,20,0.2); }
    .sortable-chosen { box-shadow: 0 10px 30px rgba(229,9,20,0.4); }

    @media (max-width: 768px) {
      body { padding: 1.2rem; }
      .items-grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
    }
  </style>
</head>
<body>

<div id="loginPage" class="login-container">
  <h1 style="text-align:center; margin-bottom:2rem;">Vynix Max Dashboard</h1>
  <div class="form-group">
    <label>Email</label>
    <input type="email" id="email" placeholder="admin@vynixmax.com" autocomplete="email"/>
  </div>
  <div class="form-group" style="margin:1.2rem 0;">
    <label>Password</label>
    <input type="password" id="password" placeholder="••••••••" autocomplete="current-password"/>
  </div>
  <button class="btn btn-primary" style="width:100%;" id="loginBtn">Login</button>
  <p id="loginError" style="color:#ff5252; margin-top:1rem; text-align:center; min-height:1.4rem;"></p>
</div>

<div id="dashboard" class="container hidden">
  <header>
    <h1>Vynix Max Admin</h1>
    <button class="btn btn-danger" id="signOutBtn">Sign Out</button>
  </header>

  <!-- Hero Section -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">Hero Section</div>
    </div>
    <div class="form-grid">
      <div class="form-group"><label>Title</label><input type="text" id="heroTitle"/></div>
      <div class="form-group"><label>Description</label><textarea id="heroDescription"></textarea></div>
      <div class="form-group"><label>Badge / Age Rating</label><input type="text" id="heroBadge" placeholder="16+"/></div>
      <div class="form-group"><label>Rating (e.g. 8.7)</label><input type="text" id="heroRating"/></div>
      <div class="form-group"><label>Year</label><input type="text" id="heroYear"/></div>
      <div class="form-group"><label>Duration (e.g. 2h 18m)</label><input type="text" id="heroDuration"/></div>
      <div class="form-group" style="grid-column: span 2;">
        <label>Background Image/Video</label>
        <div class="file-upload" id="heroUploadArea">
          Click to upload or drag & drop<br/>
          <small>Recommended: 1920×1080 or higher</small>
          <input type="file" id="heroFileInput" accept="image/*,video/*" hidden/>
          <img id="heroPreview" class="preview" alt="Preview"/>
        </div>
      </div>
    </div>
    <button class="btn btn-primary" style="margin-top:1.5rem;" id="saveHero">Save Hero</button>
  </div>

  <!-- New Releases -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">New Releases</div>
      <button class="btn btn-primary" id="toggleNewForm">Add New</button>
    </div>

    <div id="newReleaseForm" class="form-grid hidden">
      <div class="form-group"><label>Title</label><input type="text" id="newTitle"/></div>
      <div class="form-group"><label>Year</label><input type="text" id="newYear"/></div>
      <div class="form-group" style="grid-column: span 2;">
        <label>Poster / Cover (Image/Video)</label>
        <div class="file-upload" id="newUploadArea">
          Click to upload or drag & drop
          <input type="file" id="newFileInput" accept="image/*,video/*" hidden/>
          <img id="newPreview" class="preview" alt="Preview"/>
        </div>
      </div>
      <button class="btn btn-primary" id="saveNewRelease">Save & Add to New Releases</button>
    </div>

    <div class="items-grid sortable" id="newReleasesList" data-category="new"></div>
  </div>

  <!-- Trending Now -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">Trending Now</div>
      <button class="btn btn-primary" id="toggleTrendingForm">Add New</button>
    </div>

    <div id="trendingForm" class="form-grid hidden">
      <div class="form-group"><label>Title</label><input type="text" id="trendingTitle"/></div>
      <div class="form-group"><label>Year</label><input type="text" id="trendingYear"/></div>
      <div class="form-group" style="grid-column: span 2;">
        <label>Poster / Cover</label>
        <div class="file-upload" id="trendingUploadArea">
          Click to upload or drag & drop
          <input type="file" id="trendingFileInput" accept="image/*,video/*" hidden/>
          <img id="trendingPreview" class="preview" alt="Preview"/>
        </div>
      </div>
      <button class="btn btn-primary" id="saveTrending">Save & Add to Trending</button>
    </div>

    <div class="items-grid sortable" id="trendingList" data-category="trending"></div>
  </div>

  <!-- Popular on Vynix -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">Popular on Vynix</div>
      <button class="btn btn-primary" id="togglePopularForm">Add New</button>
    </div>

    <div id="popularForm" class="form-grid hidden">
      <div class="form-group"><label>Title</label><input type="text" id="popularTitle"/></div>
      <div class="form-group"><label>Year</label><input type="text" id="popularYear"/></div>
      <div class="form-group" style="grid-column: span 2;">
        <label>Poster / Cover</label>
        <div class="file-upload" id="popularUploadArea">
          Click to upload or drag & drop
          <input type="file" id="popularFileInput" accept="image/*,video/*" hidden/>
          <img id="popularPreview" class="preview" alt="Preview"/>
        </div>
      </div>
      <button class="btn btn-primary" id="savePopular">Save & Add to Popular</button>
    </div>

    <div class="items-grid sortable" id="popularList" data-category="popular"></div>
  </div>
</div>

<script>
// =============================================
// CONFIG
// =============================================
const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.appspot.com",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

// =============================================
// AUTH
// =============================================
auth.onAuthStateChanged(user => {
  if (user) {
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    loadAllContent();
  } else {
    document.getElementById('loginPage').classList.remove('hidden');
    document.getElementById('dashboard').classList.add('hidden');
  }
});

document.getElementById('loginBtn').onclick = () => {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  auth.signInWithEmailAndPassword(email, password)
    .catch(err => document.getElementById('loginError').textContent = err.message);
};

document.getElementById('signOutBtn').onclick = () => auth.signOut();

// =============================================
// FILE UPLOAD PREVIEW SETUP
// =============================================
function setupFileUpload(areaId, inputId, previewId) {
  const area = document.getElementById(areaId);
  const input = document.getElementById(inputId);
  const preview = document.getElementById(previewId);

  area.onclick = () => input.click();

  input.onchange = e => {
    const file = e.target.files[0];
    if (file) {
      preview.src = URL.createObjectURL(file);
      preview.style.display = 'block';
    }
  };

  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => area.addEventListener(ev, e => e.preventDefault()));

  area.addEventListener('drop', e => {
    const file = e.dataTransfer.files[0];
    if (file) {
      input.files = e.dataTransfer.files;
      input.dispatchEvent(new Event('change'));
    }
  });
}

setupFileUpload('heroUploadArea', 'heroFileInput', 'heroPreview');
setupFileUpload('newUploadArea', 'newFileInput', 'newPreview');
setupFileUpload('trendingUploadArea', 'trendingFileInput', 'trendingPreview');
setupFileUpload('popularUploadArea', 'popularFileInput', 'popularPreview');

// =============================================
// SAVE HERO
// =============================================
document.getElementById('saveHero').onclick = async () => {
  try {
    const file = document.getElementById('heroFileInput').files[0];
    let backgroundUrl = '';

    if (file) {
      const ref = storage.ref(`hero/${Date.now()}_${file.name}`);
      await ref.put(file);
      backgroundUrl = await ref.getDownloadURL();
    }

    const updates = {
      title: document.getElementById('heroTitle').value.trim() || '',
      description: document.getElementById('heroDescription').value.trim() || '',
      badge: document.getElementById('heroBadge').value.trim() || '16+',
      rating: document.getElementById('heroRating').value.trim() || '',
      year: document.getElementById('heroYear').value.trim() || '',
      duration: document.getElementById('heroDuration').value.trim() || '',
      backgroundImage: backgroundUrl || null,
      updatedAt: firebase.database.ServerValue.TIMESTAMP
    };

    await db.ref('/content/hero').update(updates);
    alert('Hero section saved successfully!');
  } catch (err) {
    alert('Error saving hero: ' + err.message);
  }
};

// =============================================
// GENERIC SAVE NEW ITEM
// =============================================
async function saveNewItem(category, titleId, yearId, fileInputId, previewId) {
  try {
    const title = document.getElementById(titleId).value.trim();
    const year = document.getElementById(yearId).value.trim();
    const file = document.getElementById(fileInputId).files[0];

    if (!title || !year) {
      alert('Title and Year are required!');
      return;
    }

    let imageUrl = '';
    if (file) {
      const ref = storage.ref(`${category}/${Date.now()}_${file.name}`);
      await ref.put(file);
      imageUrl = await ref.getDownloadURL();
    }

    // Get highest order for appending at the end
    const snap = await db.ref(`/content/${category}`)
      .orderByChild('order')
      .limitToLast(1)
      .once('value');

    let maxOrder = 0;
    snap.forEach(child => {
      maxOrder = child.val().order || 0;
    });

    const item = {
      title,
      year,
      image: imageUrl,
      order: maxOrder + 100,
      createdAt: firebase.database.ServerValue.TIMESTAMP
    };

    await db.ref(`/content/${category}`).push(item);

    // Clear form
    document.getElementById(titleId).value = '';
    document.getElementById(yearId).value = '';
    document.getElementById(fileInputId).value = '';
    document.getElementById(previewId).style.display = 'none';

    alert(`Item successfully added to ${category.replace(/([A-Z])/g, ' $1')}!`);
  } catch (err) {
    alert(`Error adding item to ${category}: ${err.message}`);
  }
}

// Bind save buttons
document.getElementById('saveNewRelease').onclick = () => 
  saveNewItem('new', 'newTitle', 'newYear', 'newFileInput', 'newPreview');

document.getElementById('saveTrending').onclick = () => 
  saveNewItem('trending', 'trendingTitle', 'trendingYear', 'trendingFileInput', 'trendingPreview');

document.getElementById('savePopular').onclick = () => 
  saveNewItem('popular', 'popularTitle', 'popularYear', 'popularFileInput', 'popularPreview');

// =============================================
// DELETE ITEM
// =============================================
function deleteItem(category, key) {
  if (!confirm('Are you sure you want to delete this item?')) return;
  db.ref(`/content/${category}/${key}`).remove()
    .catch(err => alert('Delete failed: ' + err.message));
}

// =============================================
// SAVE ORDER AFTER DRAG & DROP
// =============================================
async function saveOrder(containerId, category) {
  try {
    const container = document.getElementById(containerId);
    const items = Array.from(container.children);
    const updates = {};

    items.forEach((el, index) => {
      const key = el.dataset.key;
      if (key) {
        updates[`${key}/order`] = (index + 1) * 100;
      }
    });

    if (Object.keys(updates).length > 0) {
      await db.ref(`/content/${category}`).update(updates);
    }
  } catch (err) {
    alert('Failed to save order: ' + err.message);
  }
}

// =============================================
// SORTABLE INITIALIZATION
// =============================================
function initSortable(containerId, category) {
  new Sortable(document.getElementById(containerId), {
    animation: 180,
    handle: '.drag-handle',
    ghostClass: 'sortable-ghost',
    chosenClass: 'sortable-chosen',
    onEnd: () => saveOrder(containerId, category)
  });
}

// =============================================
// RENDER LIST OF ITEMS
// =============================================
function renderList(containerId, items, category) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';

  if (items.length === 0) {
    container.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:var(--text-dim);">No items yet</p>';
    return;
  }

  // Sort by order (fallback to createdAt)
  items.sort((a, b) => {
    const oa = a.order ?? a.createdAt ?? 0;
    const ob = b.order ?? b.createdAt ?? 0;
    return oa - ob;
  });

  container.innerHTML = items.map(item => `
    <div class="item-card" data-key="${item.key}">
      <div class="drag-handle"><span class="material-symbols-rounded">drag_handle</span></div>
      <img src="${item.image || 'https://via.placeholder.com/320x180?text=No+Image'}" alt="${item.title}"/>
      <div class="item-info">
        <div class="item-title">${item.title}</div>
        <div style="color:var(--text-dim);font-size:0.9rem;">${item.year}</div>
      </div>
      <div class="item-actions">
        <button class="btn btn-danger" style="padding:0.5rem 1rem;font-size:0.9rem;"
                onclick="deleteItem('${category}', '${item.key}')">Delete</button>
      </div>
    </div>
  `).join('');

  initSortable(containerId, category);
}

// =============================================
// LOAD ALL CONTENT
// =============================================
function loadAllContent() {
  // Hero (load current values)
  db.ref('/content/hero').once('value', snap => {
    const h = snap.val() || {};
    document.getElementById('heroTitle').value = h.title || '';
    document.getElementById('heroDescription').value = h.description || '';
    document.getElementById('heroBadge').value = h.badge || '16+';
    document.getElementById('heroRating').value = h.rating || '';
    document.getElementById('heroYear').value = h.year || '';
    document.getElementById('heroDuration').value = h.duration || '';

    if (h.backgroundImage) {
      document.getElementById('heroPreview').src = h.backgroundImage;
      document.getElementById('heroPreview').style.display = 'block';
    }
  });

  // Categories with real-time updates
  ['new', 'trending', 'popular'].forEach(cat => {
    db.ref(`/content/${cat}`).on('value', snap => {
      const items = [];
      snap.forEach(child => {
        items.push({ key: child.key, ...child.val() });
      });
      renderList(`${cat}List`, items, cat);
    });
  });
}

// =============================================
// TOGGLE FORMS
// =============================================
document.getElementById('toggleNewForm').onclick = () =>
  document.getElementById('newReleaseForm').classList.toggle('hidden');

document.getElementById('toggleTrendingForm').onclick = () =>
  document.getElementById('trendingForm').classList.toggle('hidden');

document.getElementById('togglePopularForm').onclick = () =>
  document.getElementById('popularForm').classList.toggle('hidden');
</script>
</body>
</html>
