<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vynix AI - Reels</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #F7F7F8;
      --card-bg: #1C2526;
      --text-primary: #FFFFFF;
      --text-secondary: #4B5EAA;
      --border: #4A5568;
      --highlight: #38B2AC;
      --badge-bg: #EF4444;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      min-height: 100vh;
      margin: 0;
      overflow-x: hidden;
    }

    .reels-container {
      height: 100vh;
      overflow-y: auto;
      scroll-snap-type: y mandatory;
      scroll-behavior: smooth;
    }

    .reel {
      height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      scroll-snap-align: start;
      background: var(--card-bg);
    }

    .reel-media {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .reel-overlay {
      position: absolute;
      bottom: 80px;
      left: 15px;
      right: 15px;
      color: var(--text-primary);
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }

    .reel-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .reel-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
      font-weight: 600;
    }

    .reel-profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--highlight);
    }

    .reel-username {
      font-weight: 600;
      font-size: 16px;
    }

    .reel-timestamp {
      font-size: 14px;
      color: rgba(255,255,255,0.7);
    }

    .reel-caption {
      font-size: 14px;
      margin-bottom: 10px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .reel-actions {
      position: absolute;
      right: 15px;
      bottom: 80px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      align-items: center;
    }

    .reel-action {
      background: none;
      border: none;
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      font-size: 12px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }

    .reel-action.liked svg {
      fill: var(--badge-bg);
      stroke: var(--badge-bg);
    }

    .reel-action svg {
      width: 24px;
      height: 24px;
      stroke: var(--text-primary);
    }

    .bottom-nav {
      position: fixed;
      bottom: 1rem;
      left: 1rem;
      right: 1rem;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 1.5rem;
      padding: 0.5rem;
      display: flex;
      justify-content: space-around;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10;
    }

    .nav-item {
      background: transparent;
      border: none;
      padding: 0.5rem;
      cursor: pointer;
      border-radius: 0.5rem;
      transition: background 0.2s;
      position: relative;
    }

    .nav-item.active, .nav-item:hover {
      background: var(--highlight);
    }

    .nav-item svg {
      width: 1.5rem;
      height: 1.5rem;
      stroke: var(--text-primary);
    }

    .nav-item .unread-badge {
      background: var(--badge-bg);
      color: var(--text-primary);
      border-radius: 9999px;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      position: absolute;
      top: -0.5rem;
      right: -0.5rem;
      min-width: 1.5rem;
      text-align: center;
    }

    .floating-upload-btn {
      position: fixed;
      bottom: 5rem;
      right: 1rem;
      background: var(--highlight);
      border: none;
      border-radius: 50%;
      width: 3rem;
      height: 3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 20;
      transition: background 0.2s;
    }

    .floating-upload-btn:hover {
      background: #2a928d;
    }

    .floating-upload-btn svg {
      width: 1.5rem;
      height: 1.5rem;
      stroke: var(--text-primary);
    }

    .upload-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }

    .upload-modal.active {
      display: flex;
    }

    .upload-modal-content {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      color: var(--text-primary);
    }

    .upload-modal-content input[type="file"] {
      display: none;
    }

    .upload-modal-content label {
      display: block;
      background: var(--highlight);
      color: var(--text-primary);
      padding: 10px;
      text-align: center;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 10px;
    }

    .upload-modal-content textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 5px;
      background: var(--bg);
      color: var(--text-secondary);
      margin-bottom: 10px;
      resize: none;
    }

    .upload-modal-content button {
      background: var(--highlight);
      color: var(--text-primary);
      border: none;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
    }

    .upload-modal-content button:hover {
      background: #2a928d;
    }

    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .spinner-overlay.active {
      display: flex;
    }

    .spinner {
      width: 100px;
      height: 4px;
      background: var(--highlight);
      border-radius: 2px;
      animation: loading 1.5s ease-in-out infinite;
    }

    @keyframes loading {
      0% { transform: scaleX(0); transform-origin: left; }
      50% { transform: scaleX(1); transform-origin: left; }
      51% { transform-origin: right; }
      100% { transform: scaleX(0); transform-origin: right; }
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .reel {
      animation: slideIn 0.3s ease-out;
    }

    @media (max-width: 768px) {
      .reel-actions {
        bottom: 70px;
      }

      .floating-upload-btn {
        bottom: 4.5rem;
      }
    }
  </style>
</head>
<body>
  <main class="flex flex-col h-screen" id="main-content">
    <div class="reels-container" id="reels-container">
      <!-- Reels will be dynamically loaded here -->
    </div>

    <div class="bottom-nav">
      <button class="nav-item" onclick="window.location.href='home.html'">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
      </button>
      <button class="nav-item" onclick="window.location.href='friends.html'" id="friends-nav">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
        </svg>
      </button>
      <button class="nav-item active" onclick="window.location.href='index.html'">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
        </svg>
      </button>
      <button class="nav-item" onclick="window.location.href='profile.html'">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
        </svg>
      </button>
    </div>

    <button class="floating-upload-btn" id="upload-btn">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
        <path d="M12 4v8m0 0v8m8-8H4"/>
      </svg>
    </button>

    <div class="upload-modal" id="upload-modal">
      <div class="upload-modal-content">
        <label for="media-upload">Select Image/Video</label>
        <input type="file" id="media-upload" accept="image/*,video/*" multiple>
        <textarea id="caption-input" placeholder="Add a caption..." rows="3"></textarea>
        <button id="submit-upload">Upload</button>
      </div>
    </div>

    <div id="spinner-overlay" class="spinner-overlay">
      <div class="spinner"></div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, onValue, push, update } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    // Cloudinary configuration for unsigned uploads
    const CLOUDINARY_CLOUD_NAME = 'your_cloud_name'; // Replace with your Cloudinary cloud name
    const CLOUDINARY_UPLOAD_PRESET = 'your_upload_preset'; // Replace with your unsigned upload preset

    let app, auth, db, currentUser;
    const encryptionKey = new TextEncoder().encode('vynix-ai-secret-key-32bytes123456');

    const showSpinner = () => {
      document.getElementById('spinner-overlay').classList.add('active');
      document.getElementById('main-content').setAttribute('aria-busy', 'true');
    };

    const hideSpinner = () => {
      document.getElementById('spinner-overlay').classList.remove('active');
      document.getElementById('main-content').setAttribute('aria-busy', 'false');
    };

    async function encryptMessage(message) {
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const encrypted = await crypto.subtle.encrypt(
        { name: 'AES-GCM', iv },
        await crypto.subtle.importKey('raw', encryptionKey, 'AES-GCM', false, ['encrypt']),
        new TextEncoder().encode(message)
      );
      const encryptedArray = new Uint8Array(encrypted);
      return { iv: Array.from(iv), data: Array.from(encryptedArray) };
    }

    async function decryptMessage(encryptedData, iv) {
      try {
        const decrypted = await crypto.subtle.decrypt(
          { name: 'AES-GCM', iv: new Uint8Array(iv) },
          await crypto.subtle.importKey('raw', encryptionKey, 'AES-GCM', false, ['decrypt']),
          new Uint8Array(encryptedData)
        );
        return new TextDecoder().decode(decrypted);
      } catch (error) {
        console.error('Decryption Error:', error);
        return '[Encrypted Message]';
      }
    }

    function initializeFirebase() {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getDatabase(app);
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          update(ref(db, `users/${user.uid}`), { lastSeen: new Date().toISOString() });
          loadReels();
          loadUnreadMessages();
        } else {
          window.location.href = 'signup.html';
        }
      });
    }

    async function loadReels() {
      showSpinner();
      const reelsRef = ref(db, 'reels');
      try {
        onValue(reelsRef, async (snapshot) => {
          const reelsContainer = document.getElementById('reels-container');
          reelsContainer.innerHTML = '';
          const reels = snapshot.val();
          if (!reels) {
            reelsContainer.innerHTML = '<p style="text-align: center; color: var(--text-primary); margin-top: 2rem;">No reels available.</p>';
            hideSpinner();
            return;
          }
          const reelsArray = Object.entries(reels)
            .map(([reelId, reelData]) => ({ reelId, ...reelData }))
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          for (const reel of reelsArray) {
            const userRef = ref(db, `users/${reel.userId}`);
            onValue(userRef, async (userSnapshot) => {
              const userData = userSnapshot.val();
              const caption = reel.captionEncrypted
                ? await decryptMessage(reel.captionEncrypted.data, reel.captionEncrypted.iv)
                : reel.caption || '';
              const div = document.createElement('div');
              div.className = 'reel';
              const isVideo = reel.mediaType === 'video';
              div.innerHTML = `
                ${isVideo
                  ? `<video class="reel-media" src="${reel.mediaURL}" autoplay loop muted playsinline></video>`
                  : `<img class="reel-media" src="${reel.mediaURL}" alt="Reel image">`}
                <div class="reel-overlay">
                  <div class="reel-header">
                    ${userData?.photoURL
                      ? `<img src="${userData.photoURL}" class="reel-profile-pic" alt="${userData.displayName}'s profile picture">`
                      : `<div class="reel-avatar">${userData?.displayName ? userData.displayName[0].toUpperCase() : 'U'}</div>`}
                    <div>
                      <div class="reel-username">${userData?.displayName || 'User'}</div>
                      <div class="reel-timestamp">${reel.timestamp ? new Date(reel.timestamp).toLocaleTimeString() : ''}</div>
                    </div>
                  </div>
                  <div class="reel-caption">${caption.slice(0, 100)}${caption.length > 100 ? '...' : ''}</div>
                </div>
                <div class="reel-actions">
                  <button class="reel-action ${reel.likedBy?.[currentUser.uid] ? 'liked' : ''}" onclick="toggleLike('${reel.reelId}', this)">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                      <path d="M7 22h1V9H5a3 3 0 003 3h2l2-2 2 2h2a3 3 0 003-3h-3V9h1"/>
                    </svg>
                    <span>${Object.keys(reel.likedBy || {}).length}</span>
                  </button>
                  <button class="reel-action">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                      <path d="M21 11.5a8.38 8.38 0 01-11.5 7 8.38 8.38 0 01-7-11.5 8.38 8.38 0 0111.5-7c3.1 1.1 5 4 5 7.5z"/>
                    </svg>
                    <span>${Object.keys(reel.comments || {}).length}</span>
                  </button>
                  <button class="reel-action">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                      <path d="M15 15l6-6m0 0l-6-6m6 6H9a6 6 0 000 12h3"/>
                    </svg>
                    <span>Share</span>
                  </button>
                </div>
              `;
              reelsContainer.appendChild(div);
            }, { onlyOnce: true });
          }
          hideSpinner();
        }, { onlyOnce: false });
      } catch (error) {
        console.error('Error loading reels:', error);
        hideSpinner();
      }
    }

    async function toggleLike(reelId, button) {
      if (!currentUser) return;
      const reelRef = ref(db, `reels/${reelId}/likedBy/${currentUser.uid}`);
      const isLiked = button.classList.contains('liked');
      try {
        await update(ref(db, `reels/${reelId}/likedBy`), {
          [currentUser.uid]: isLiked ? null : true
        });
        button.classList.toggle('liked');
        const countSpan = button.querySelector('span');
        const currentCount = parseInt(countSpan.textContent) || 0;
        countSpan.textContent = isLiked ? currentCount - 1 : currentCount + 1;
      } catch (error) {
        console.error('Error toggling like:', error);
      }
    }

    function loadUnreadMessages() {
      const friendsRef = ref(db, `users/${currentUser.uid}/friends`);
      onValue(friendsRef, (snapshot) => {
        const friends = snapshot.val();
        let totalUnread = 0;
        if (friends) {
          Object.values(friends).forEach(friend => {
            totalUnread += friend.unreadCount || 0;
          });
        }
        const friendsNav = document.getElementById('friends-nav');
        friendsNav.querySelector('.unread-badge')?.remove();
        if (totalUnread > 0) {
          const badge = document.createElement('span');
          badge.className = 'unread-badge';
          badge.textContent = totalUnread;
          badge.style.cssText = 'background: var(--badge-bg); color: var(--text-primary); border-radius: 9999px; padding: 0.25rem 0.5rem; font-size: 0.75rem; position: absolute; top: -0.5rem; right: -0.5rem; min-width: 1.5rem; text-align: center;';
          friendsNav.appendChild(badge);
        }
      });
    }

    async function uploadMedia(files, caption) {
      if (!currentUser || !files.length) return;
      showSpinner();
      try {
        for (const file of files) {
          const formData = new FormData();
          formData.append('file', file);
          formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

          const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${file.type.startsWith('video') ? 'video' : 'image'}/upload`, {
            method: 'POST',
            body: formData
          });
          const data = await response.json();
          if (data.secure_url) {
            const encryptedCaption = caption ? await encryptMessage(caption) : null;
            const reelsRef = ref(db, 'reels');
            await push(reelsRef, {
              userId: currentUser.uid,
              mediaURL: data.secure_url,
              mediaType: file.type.startsWith('video') ? 'video' : 'image',
              captionEncrypted: encryptedCaption,
              timestamp: new Date().toISOString(),
              likedBy: {},
              comments: {}
            });
          } else {
            console.error('Upload failed:', data.error?.message);
          }
        }
        document.getElementById('upload-modal').classList.remove('active');
        document.getElementById('media-upload').value = '';
        document.getElementById('caption-input').value = '';
        loadReels();
      } catch (error) {
        console.error('Error uploading media:', error);
        hideSpinner();
      }
    }

    document.getElementById('upload-btn').addEventListener('click', () => {
      document.getElementById('upload-modal').classList.add('active');
    });

    document.getElementById('submit-upload').addEventListener('click', () => {
      const files = document.getElementById('media-upload').files;
      const caption = document.getElementById('caption-input').value.trim();
      uploadMedia(files, caption);
    });

    document.addEventListener('DOMContentLoaded', initializeFirebase);

    window.toggleLike = toggleLike;
  </script>
</body>
</html>
