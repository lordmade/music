<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vynix AI - Reels</title>
  <style>
    :root {
      --bg: #000;
      --text: #fff;
      --text-secondary: #8e8e8e;
      --border: rgba(255, 255, 255, 0.1);
      --highlight: #0095f6;
      --badge-bg: #fa3e5f;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .reels-container {
      height: 100vh;
      overflow-y: auto;
      scroll-snap-type: y mandatory;
    }

    .reel {
      height: 100vh;
      position: relative;
      scroll-snap-align: start;
      background: var(--bg);
    }

    .reel-media {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .play-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      color: var(--text);
      opacity: 0.7;
      transition: opacity 0.2s;
      z-index: 10;
    }

    .play-icon.hidden {
      opacity: 0;
    }

    .reel-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 10px;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .reel-username {
      font-size: 14px;
      font-weight: 600;
    }

    .reel-timestamp {
      font-size: 12px;
      color: var(--text-secondary);
      margin-left: 8px;
    }

    .btn {
      padding: 6px 12px;
      border-radius: 20px;
      border: none;
      background: var(--highlight);
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
    }

    .reel-actions {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 8px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 20px;
    }

    .reel-action {
      background: none;
      border: none;
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 12px;
    }

    .reel-action svg {
      width: 24px;
      height: 24px;
      stroke: var(--text);
    }

    .reel-action.liked svg {
      fill: var(--badge-bg);
      stroke: var(--badge-bg);
    }

    .progress-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 2px;
      background: var(--highlight);
    }

    .bottom-nav {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.5);
      border-radius: 20px;
      display: flex;
      padding: 6px;
      width: 90%;
      max-width: 300px;
      z-index: 10;
    }

    .nav-item {
      flex: 1;
      background: none;
      border: none;
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 10px;
    }

    .nav-item svg {
      width: 20px;
      height: 20px;
      stroke: var(--text);
    }

    .nav-item.active svg {
      stroke: var(--highlight);
    }

    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg);
      padding: 10px;
      max-height: 80vh;
      overflow-y: auto;
      transform: translateY(100%);
      transition: transform 0.2s;
      z-index: 20;
    }

    .bottom-sheet.active {
      transform: translateY(0);
    }

    .bottom-sheet textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: transparent;
      color: var(--text);
      font-size: 14px;
    }

    .alert {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.5);
      color: var(--text);
      padding: 8px 16px;
      border-radius: 20px;
      display: none;
      z-index: 30;
    }

    .alert.active {
      display: block;
    }

    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .spinner-overlay.active {
      display: flex;
    }

    .spinner {
      width: 30px;
      height: 30px;
      border: 3px solid var(--highlight);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (min-width: 769px) {
      .bottom-nav { display: none; }
      .reels-container { margin-left: 60px; width: calc(100% - 60px); }
      .sidebar {
        display: flex;
        position: fixed;
        top: 50%;
        left: 10px;
        transform: translateY(-50%);
        flex-direction: column;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 20px;
        padding: 10px;
        z-index: 10;
      }
    }
  </style>
</head>
<body>
  <main class="flex flex-col h-screen">
    <nav class="sidebar">
      <button class="nav-item active" id="home-btn">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 2c5.52 0 10 4.48 10 10s-4.48 10-10 10S2 17.52 2 12 6.48 2 12 2z"/></svg>
        <span>Feed</span>
      </button>
      <button class="nav-item" id="upload-nav-btn">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v8m0 0v8m8-8H4"/></svg>
      </button>
      <button class="nav-item" id="friends-nav-btn">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z"/></svg>
        <span>Friends</span>
      </button>
    </nav>

    <div class="reels-container" id="reels-container">
      <p style="text-align: center; color: var(--text); margin-top: 2rem;">Loading...</p>
    </div>

    <nav class="bottom-nav">
      <button class="nav-item" id="search-nav-btn-mobile">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z"/></svg>
        <span>Search</span>
      </button>
      <button class="nav-item active" id="home-btn-mobile">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 2c5.52 0 10 4.48 10 10s-4.48 10-10 10S2 17.52 2 12 6.48 2 12 2z"/></svg>
        <span>Feed</span>
      </button>
      <button class="nav-item" id="upload-nav-btn-mobile">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v8m0 0v8m8-8H4"/></svg>
      </button>
      <button class="nav-item" id="friends-nav-btn-mobile">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z"/></svg>
        <span>Friends</span>
      </button>
    </nav>

    <div class="bottom-sheet" id="upload-sheet">
      <button class="btn" onclick="closeBottomSheet()">Close</button>
      <div>
        <label class="btn" for="media-upload">Select Media</label>
        <input type="file" id="media-upload" accept="image/*,video/*" multiple>
        <div id="preview-container"></div>
        <textarea id="caption-input" placeholder="Caption..." rows="3"></textarea>
        <button class="btn" id="submit-upload">Post</button>
      </div>
    </div>

    <div class="bottom-sheet" id="comment-sheet">
      <button class="btn" onclick="closeBottomSheet()">Close</button>
      <div>
        <div id="comment-list"></div>
        <textarea id="comment-input" placeholder="Comment..." rows="2"></textarea>
        <button class="btn" id="submit-comment">Post</button>
      </div>
    </div>

    <div id="spinner-overlay" class="spinner-overlay">
      <div class="spinner"></div>
    </div>
    <div id="alert-message" class="alert"></div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/dqkujefxj/upload';
    const CLOUDINARY_PRESET = 'banter_box';

    let app, auth, db, currentUser, observer;

    function showSpinner() {
      document.getElementById('spinner-overlay').classList.add('active');
    }

    function hideSpinner() {
      document.getElementById('spinner-overlay').classList.remove('active');
    }

    function showAlert(message) {
      const alert = document.getElementById('alert-message');
      alert.textContent = message;
      alert.classList.add('active');
      setTimeout(() => alert.classList.remove('active'), 2000);
    }

    function openBottomSheet(type, reelId = null) {
      document.getElementById(`${type}-sheet`).classList.add('active');
      if (type === 'comment') {
        activeCommentReelId = reelId;
        loadComments(reelId);
      }
    }

    function closeBottomSheet() {
      document.querySelectorAll('.bottom-sheet').forEach(sheet => sheet.classList.remove('active'));
      document.getElementById('media-upload').value = '';
      document.getElementById('caption-input').value = '';
      document.getElementById('preview-container').innerHTML = '';
      document.getElementById('comment-input').value = '';
      document.getElementById('comment-list').innerHTML = '';
      activeCommentReelId = null;
    }

    function initializeFirebase() {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getDatabase(app);
      onAuthStateChanged(auth, user => {
        currentUser = user;
        if (user) {
          update(ref(db, `users/${user.uid}`), { lastSeen: new Date().toISOString() });
          loadReels();
        } else {
          showAlert('Please log in.');
          window.location.href = 'signup.html';
        }
      });
    }

    function pauseAllVideos(exceptId) {
      document.querySelectorAll('.reel-media').forEach(video => {
        if (video.tagName === 'VIDEO' && video.closest('.reel').dataset.reelId !== exceptId) {
          video.pause();
          video.currentTime = 0;
          const progressBar = document.getElementById(`progress-${video.closest('.reel').dataset.reelId}`);
          if (progressBar) progressBar.style.width = '0';
          const playIcon = video.closest('.reel').querySelector('.play-icon');
          if (playIcon) playIcon.classList.remove('hidden');
        }
      });
    }

    async function loadReels() {
      showSpinner();
      const reelsRef = ref(db, 'reels');
      onValue(reelsRef, snapshot => {
        const reelsContainer = document.getElementById('reels-container');
        if (!snapshot.exists()) {
          reelsContainer.innerHTML = '<p style="text-align: center;">No reels available.</p>';
          hideSpinner();
          return;
        }
        const reels = snapshot.val();
        reelsContainer.innerHTML = '';
        Object.entries(reels).forEach(([reelId, reelData]) => {
          const div = document.createElement('div');
          div.className = 'reel';
          div.dataset.reelId = reelId;
          const isVideo = reelData.mediaType === 'video';
          div.innerHTML = `
            ${isVideo
              ? `<video class="reel-media" src="${reelData.mediaURL}" playsinline></video>
                 <svg class="play-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 3l14 9-14 9V3z"/></svg>
                 <div class="progress-bar" id="progress-${reelId}"></div>`
              : `<img class="reel-media" src="${reelData.mediaURL}" alt="Reel image" loading="lazy">`}
            <div class="reel-header">
              <div>
                <span class="reel-username">${reelData.userId}</span>
                <span class="reel-timestamp">${formatTimestamp(reelData.timestamp)}</span>
              </div>
              <button class="btn" onclick="openBottomSheet('comment', '${reelId}')">Comments (${Object.keys(reelData.comments || {}).length})</button>
            </div>
            <div class="reel-actions">
              <button class="reel-action ${reelData.likedBy?.[currentUser?.uid] ? 'liked' : ''}" onclick="toggleLike('${reelId}', this)">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>
                <span>${Object.keys(reelData.likedBy || {}).length}</span>
              </button>
            </div>
          `;
          reelsContainer.appendChild(div);
          if (isVideo) {
            const video = div.querySelector('.reel-media');
            const progressBar = div.querySelector(`#progress-${reelId}`);
            const playIcon = div.querySelector('.play-icon');
            video.addEventListener('click', () => {
              if (video.paused) {
                pauseAllVideos(reelId);
                video.play();
                playIcon.classList.add('hidden');
              } else {
                video.pause();
                playIcon.classList.remove('hidden');
              }
            });
            video.addEventListener('timeupdate', () => {
              if (!video.paused) {
                progressBar.style.width = `${(video.currentTime / video.duration) * 100}%`;
              }
            });
          }
        });
        hideSpinner();
        observeReels();
      });
    }

    async function toggleLike(reelId, button) {
      if (!currentUser) {
        showAlert('Please log in.');
        return;
      }
      const isLiked = button.classList.contains('liked');
      const countSpan = button.querySelector('span');
      const count = parseInt(countSpan.textContent) || 0;
      await update(ref(db, `reels/${reelId}/likedBy`), {
        [currentUser.uid]: isLiked ? null : true
      });
      button.classList.toggle('liked');
      countSpan.textContent = isLiked ? count - 1 : count + 1;
    }

    async function loadComments(reelId) {
      const commentList = document.getElementById('comment-list');
      commentList.innerHTML = '';
      const commentsRef = ref(db, `reels/${reelId}/comments`);
      onValue(commentsRef, snapshot => {
        if (!snapshot.exists()) {
          commentList.innerHTML = '<p>No comments yet.</p>';
          return;
        }
        const comments = snapshot.val();
        Object.entries(comments).forEach(([commentId, commentData]) => {
          const div = document.createElement('div');
          div.innerHTML = `
            <div>
              <span>${commentData.userId}</span>
              <span>${formatTimestamp(commentData.timestamp)}</span>
            </div>
            <p>${commentData.comment}</p>
          `;
          commentList.appendChild(div);
        });
      });
    }

    async function submitComment(reelId) {
      if (!currentUser) {
        showAlert('Please log in.');
        return;
      }
      const commentInput = document.getElementById('comment-input');
      const commentText = commentInput.value.trim();
      if (!commentText) {
        showAlert('Please enter a comment.');
        return;
      }
      await push(ref(db, `reels/${reelId}/comments`), {
        userId: currentUser.uid,
        comment: commentText,
        timestamp: new Date().toISOString()
      });
      commentInput.value = '';
      loadComments(reelId);
    }

    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      const diff = Math.floor((Date.now() - date) / 1000);
      if (diff < 60) return `${diff}s ago`;
      if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
      return `${Math.floor(diff / 86400)}d ago`;
    }

    function showPreviews(files) {
      const previewContainer = document.getElementById('preview-container');
      previewContainer.innerHTML = '';
      Array.from(files).forEach(file => {
        const isVideo = file.type.startsWith('video');
        const url = URL.createObjectURL(file);
        const div = document.createElement('div');
        div.innerHTML = isVideo
          ? `<video src="${url}" muted></video>`
          : `<img src="${url}" alt="Preview" loading="lazy">`;
        previewContainer.appendChild(div);
      });
    }

    async function uploadMedia(files, caption) {
      if (!currentUser || !files.length) {
        showAlert('Please log in or select a file.');
        return;
      }
      showSpinner();
      for (const file of files) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_PRESET);
        const res = await fetch(CLOUDINARY_URL, {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        if (data.secure_url) {
          await push(ref(db, 'reels'), {
            userId: currentUser.uid,
            mediaURL: data.secure_url,
            mediaType: file.type.startsWith('video') ? 'video' : 'image',
            caption: caption || null,
            timestamp: new Date().toISOString(),
            likedBy: {},
            comments: {}
          });
        }
      }
      closeBottomSheet();
      loadReels();
      hideSpinner();
    }

    function observeReels() {
      observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          const reel = entry.target;
          const video = reel.querySelector('.reel-media');
          if (video && video.tagName === 'VIDEO') {
            const playIcon = reel.querySelector('.play-icon');
            if (entry.isIntersecting && entry.intersectionRatio >= 0.7) {
              pauseAllVideos(reel.dataset.reelId);
              video.play();
              playIcon.classList.add('hidden');
            } else {
              video.pause();
              video.currentTime = 0;
              playIcon.classList.remove('hidden');
            }
          }
        });
      }, { threshold: 0.7 });
      document.querySelectorAll('.reel').forEach(reel => observer.observe(reel));
    }

    document.getElementById('upload-nav-btn').addEventListener('click', () => openBottomSheet('upload'));
    document.getElementById('upload-nav-btn-mobile').addEventListener('click', () => openBottomSheet('upload'));
    document.getElementById('friends-nav-btn').addEventListener('click', () => window.location.href = 'friends.html');
    document.getElementById('friends-nav-btn-mobile').addEventListener('click', () => window.location.href = 'friends.html');
    document.getElementById('home-btn').addEventListener('click', loadReels);
    document.getElementById('home-btn-mobile').addEventListener('click', loadReels);
    document.getElementById('media-upload').addEventListener('change', e => showPreviews(e.target.files));
    document.getElementById('submit-upload').addEventListener('click', async () => {
      const files = document.getElementById('media-upload').files;
      const caption = document.getElementById('caption-input').value.trim();
      await uploadMedia(files, caption);
    });
    document.getElementById('submit-comment').addEventListener('click', () => submitComment(activeCommentReelId));
    document.addEventListener('DOMContentLoaded', initializeFirebase);
  </script>
</body>
</html>
