<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vynix Max • Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
 
  <!-- Firebase v9 compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg: #000;
      --surface: #111;
      --surface-hover: #1a1a1a;
      --accent: #e50914;
      --accent-hover: #f40613;
      --text: #ffffff;
      --text-dim: #aaa;
      --border: rgba(255,255,255,0.08);
      --radius: 12px;
      --transition: all 0.25s ease;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, sans-serif;
      min-height: 100vh;
      padding: 1.5rem;
    }
    .container { max-width: 1280px; margin: 0 auto; }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2.5rem;
    }
    h1 { font-size: 2.3rem; font-weight: 900; letter-spacing: -1px; }
    .btn {
      padding: 0.7rem 1.5rem;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: var(--transition);
    }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); }
    .btn-danger { background: #c62828; color: white; }
    .btn-danger:hover { background: #d32f2f; }
    .section {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 1.8rem;
      margin-bottom: 2.2rem;
      border: 1px solid var(--border);
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.4rem;
    }
    .section-title { font-size: 1.55rem; font-weight: 700; }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.4rem;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    label {
      font-weight: 600;
      font-size: 0.94rem;
      color: var(--text-dim);
    }
    input, textarea {
      padding: 0.9rem 1.1rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: white;
      font-size: 0.97rem;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(229,9,20,0.18);
    }
    textarea { min-height: 94px; resize: vertical; }
    .upload-area {
      border: 2px dashed var(--border);
      border-radius: 10px;
      padding: 1.6rem;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
    }
    .upload-area:hover {
      border-color: var(--accent);
      background: rgba(229,9,20,0.04);
    }
    .upload-area input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }
    .preview {
      max-width: 100%;
      max-height: 180px;
      margin-top: 1rem;
      border-radius: 8px;
      display: none;
    }
    .progress-bar {
      height: 4px;
      background: var(--accent);
      width: 0%;
      transition: width 0.35s ease;
      margin-top: 0.8rem;
      border-radius: 2px;
    }
    .items-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
      gap: 1.5rem;
      margin-top: 1.6rem;
    }
    .item-card {
      background: rgba(255,255,255,0.04);
      border-radius: 10px;
      overflow: hidden;
      transition: var(--transition);
      position: relative;
      cursor: grab;
      user-select: none;
    }
    .item-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 14px 32px rgba(0,0,0,0.45);
    }
    .item-card img {
      width: 100%;
      aspect-ratio: 1/1;
      object-fit: cover;
    }
    .item-info { padding: 1rem; text-align: center; }
    .item-title { font-weight: 600; margin-bottom: 0.4rem; font-size: 1.1rem; }
    .item-year { color: var(--text-dim); font-size: 0.9rem; }
    .item-actions {
      display: flex;
      justify-content: center;
      gap: 0.7rem;
      padding: 0.8rem 1rem;
    }
    .drag-handle {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.65);
      color: white;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      cursor: grab;
      z-index: 10;
    }
    .login-container {
      max-width: 420px;
      margin: 10vh auto;
      background: var(--surface);
      padding: 2.8rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }
    .hidden { display: none !important; }
    .sortable-ghost { opacity: 0.35; background: rgba(229,9,20,0.15); }
    .sortable-chosen { box-shadow: 0 12px 32px rgba(229,9,20,0.35); }
    #editModal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.82);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }
    .modal-content {
      background: var(--surface);
      border-radius: var(--radius);
      width: 92%;
      max-width: 540px;
      padding: 2.2rem;
      border: 1px solid var(--border);
      position: relative;
    }
    @media (max-width: 768px) {
      body { padding: 1rem; }
      .form-grid { grid-template-columns: 1fr; }
      .items-grid { grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); }
    }
  </style>
</head>
<body>

<div id="loginPage" class="login-container">
  <h1 style="text-align:center; margin-bottom:2.2rem;">Vynix Max Dashboard</h1>
  <div class="form-group">
    <label>Email</label>
    <input type="email" id="email" placeholder="admin@vynixmax.com" autocomplete="email"/>
  </div>
  <div class="form-group" style="margin:1.3rem 0;">
    <label>Password</label>
    <input type="password" id="password" placeholder="••••••••" autocomplete="current-password"/>
  </div>
  <button class="btn btn-primary" style="width:100%; padding:0.9rem;" id="loginBtn">Login</button>
  <p id="loginError" style="color:#ff5252; margin-top:1.2rem; text-align:center; min-height:1.5rem;"></p>
</div>

<div id="dashboard" class="container hidden">

  <header>
    <h1>Vynix Max Admin</h1>
    <button class="btn btn-danger" id="signOutBtn">Sign Out</button>
  </header>

  <!-- Hero Section -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">Hero Section</div>
    </div>
    <div class="form-grid">
      <div class="form-group"><label>Title</label><input type="text" id="heroTitle"/></div>
      <div class="form-group"><label>Description</label><textarea id="heroDescription"></textarea></div>
      <div class="form-group"><label>Badge / Age Rating</label><input type="text" id="heroBadge" placeholder="16+"/></div>
      <div class="form-group"><label>Rating (e.g. 8.7)</label><input type="text" id="heroRating"/></div>
      <div class="form-group"><label>Year</label><input type="text" id="heroYear"/></div>
      <div class="form-group"><label>Duration (e.g. 2h 18m)</label><input type="text" id="heroDuration"/></div>
      <div class="form-group" style="grid-column: span 2;">
        <label>Background Image/Video</label>
        <div class="upload-area" id="heroUploadArea">
          <span>Click or drag & drop (Image/Video)</span>
          <input type="file" id="heroFileInput" accept="image/*,video/*"/>
          <img id="heroPreview" class="preview" alt="Preview"/>
          <div id="heroProgress" class="progress-bar"></div>
        </div>
      </div>
    </div>
    <button class="btn btn-primary" style="margin-top:1.6rem; width:100%;" id="saveHero">Save Hero Section</button>
  </div>

  <!-- New Releases -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">New Releases</div>
      <button class="btn btn-primary" id="toggleNewForm">+ Add Movie</button>
    </div>
    <div id="newReleaseForm" class="form-grid hidden">
      <div class="form-group"><label>Title</label><input type="text" id="newTitle"/></div>
      <div class="form-group"><label>Year</label><input type="text" id="newYear"/></div>
      <div class="form-group" style="grid-column: span 2;">
        <label>Poster / Cover</label>
        <div class="upload-area" id="newUploadArea">
          <span>Click or drag & drop</span>
          <input type="file" id="newFileInput" accept="image/*,video/*"/>
          <img id="newPreview" class="preview" alt="Preview"/>
          <div id="newProgress" class="progress-bar"></div>
        </div>
      </div>
      <button class="btn btn-primary" style="margin-top:0.8rem; grid-column: span 2; width:100%;" id="saveNewRelease">Save & Add Movie</button>
    </div>
    <div class="items-grid sortable" id="newReleasesList" data-category="new"></div>
  </div>

  <!-- Trending Now -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">Trending Now</div>
      <button class="btn btn-primary" id="toggleTrendingForm">+ Add Movie</button>
    </div>
    <div id="trendingForm" class="form-grid hidden">
      <div class="form-group"><label>Title</label><input type="text" id="trendingTitle"/></div>
      <div class="form-group"><label>Year</label><input type="text" id="trendingYear"/></div>
      <div class="form-group" style="grid-column: span 2;">
        <label>Poster / Cover</label>
        <div class="upload-area" id="trendingUploadArea">
          <span>Click or drag & drop</span>
          <input type="file" id="trendingFileInput" accept="image/*,video/*"/>
          <img id="trendingPreview" class="preview" alt="Preview"/>
          <div id="trendingProgress" class="progress-bar"></div>
        </div>
      </div>
      <button class="btn btn-primary" style="margin-top:0.8rem; grid-column: span 2; width:100%;" id="saveTrending">Save & Add Movie</button>
    </div>
    <div class="items-grid sortable" id="trendingList" data-category="trending"></div>
  </div>

  <!-- Popular on Vynix -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">Popular on Vynix</div>
      <button class="btn btn-primary" id="togglePopularForm">+ Add Movie</button>
    </div>
    <div id="popularForm" class="form-grid hidden">
      <div class="form-group"><label>Title</label><input type="text" id="popularTitle"/></div>
      <div class="form-group"><label>Year</label><input type="text" id="popularYear"/></div>
      <div class="form-group" style="grid-column: span 2;">
        <label>Poster / Cover</label>
        <div class="upload-area" id="popularUploadArea">
          <span>Click or drag & drop</span>
          <input type="file" id="popularFileInput" accept="image/*,video/*"/>
          <img id="popularPreview" class="preview" alt="Preview"/>
          <div id="popularProgress" class="progress-bar"></div>
        </div>
      </div>
      <button class="btn btn-primary" style="margin-top:0.8rem; grid-column: span 2; width:100%;" id="savePopular">Save & Add Movie</button>
    </div>
    <div class="items-grid sortable" id="popularList" data-category="popular"></div>
  </div>

  <!-- ====================== NEW MUSIC SECTION ====================== -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">Music Library</div>
      <button class="btn btn-primary" id="toggleMusicForm">+ Add Track</button>
    </div>

    <div id="musicForm" class="form-grid hidden">
      <div class="form-group"><label>Title *</label><input type="text" id="musicTitle"/></div>
      <div class="form-group"><label>Artist *</label><input type="text" id="musicArtist"/></div>
      <div class="form-group"><label>Album</label><input type="text" id="musicAlbum"/></div>
      <div class="form-group"><label>Year</label><input type="text" id="musicYear"/></div>
      <div class="form-group"><label>Genre</label><input type="text" id="musicGenre"/></div>
      
      <div class="form-group" style="grid-column: span 2;">
        <label>Cover Art</label>
        <div class="upload-area" id="musicCoverUploadArea">
          <span>Click or drag & drop (Image)</span>
          <input type="file" id="musicCoverFileInput" accept="image/*"/>
          <img id="musicCoverPreview" class="preview" alt="Cover Preview"/>
          <div id="musicCoverProgress" class="progress-bar"></div>
        </div>
      </div>
      
      <div class="form-group" style="grid-column: span 2;">
        <label>Audio File * (mp3, wav, etc.)</label>
        <div class="upload-area" id="musicAudioUploadArea">
          <span>Click or drag & drop (Audio)</span>
          <input type="file" id="musicAudioFileInput" accept="audio/*"/>
          <audio id="musicAudioPreview" controls style="display:none; width:100%; margin-top:1rem; border-radius:8px;"></audio>
          <div id="musicAudioProgress" class="progress-bar"></div>
        </div>
      </div>
      
      <button class="btn btn-primary" style="margin-top:0.8rem; grid-column: span 2; width:100%;" id="saveMusicTrack">Save & Add Track</button>
    </div>

    <div class="items-grid sortable" id="musicList" data-category="music"></div>
  </div>
  <!-- ====================== END MUSIC SECTION ====================== -->

</div>

<!-- Edit Modal (same for movies & music for now) -->
<div id="editModal" class="hidden">
  <div class="modal-content">
    <h2 style="margin-bottom:1.8rem;">Edit Item</h2>
    <div class="form-grid">
      <div class="form-group">
        <label>Category</label>
        <input type="text" id="editCategory" readonly style="background:rgba(255,255,255,0.03);"/>
      </div>
      <div class="form-group">
        <label>Title *</label>
        <input type="text" id="editTitle"/>
      </div>
      <div class="form-group">
        <label id="editSubtitleLabel">Year / Artist</label>
        <input type="text" id="editYear"/>
      </div>
      <div class="form-group" style="grid-column: span 2;">
        <label>Poster / Cover (optional - leave empty to keep current)</label>
        <div class="upload-area" id="editUploadArea">
          <span>Click or drag & drop to replace</span>
          <input type="file" id="editFileInput" accept="image/*,audio/*"/>
          <img id="editPreview" class="preview" alt="Preview"/>
          <div id="editProgress" class="progress-bar"></div>
        </div>
        <div style="margin-top:0.6rem; font-size:0.9rem; color:var(--text-dim);">
          Current: <span id="editCurrentImageText">no image</span>
        </div>
      </div>
    </div>
    <div style="margin-top:2.2rem; display:flex; gap:1rem; justify-content:flex-end; flex-wrap:wrap;">
      <button class="btn" id="cancelEdit" style="background:#444;">Cancel</button>
      <button class="btn btn-danger" id="deleteEditBtn">Delete</button>
      <button class="btn btn-primary" id="saveEditBtn">Save Changes</button>
    </div>
  </div>
</div>

<script>
// =============================================
// CONFIGURATION
// =============================================
const CLOUD_NAME = "dqkujefxj";
const UPLOAD_PRESET = "banter_box";
const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.appspot.com",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// =============================================
// STATE
// =============================================
let currentEditingKey = null;
let currentEditingCategory = null;
let originalImageUrl = null;

// =============================================
// AUTHENTICATION
// =============================================
auth.onAuthStateChanged(user => {
  if (user) {
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    loadAllContent();
  } else {
    document.getElementById('loginPage').classList.remove('hidden');
    document.getElementById('dashboard').classList.add('hidden');
  }
});

document.getElementById('loginBtn').onclick = () => {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  auth.signInWithEmailAndPassword(email, password)
    .catch(err => {
      document.getElementById('loginError').textContent = err.message;
    });
};

document.getElementById('signOutBtn').onclick = () => auth.signOut();

// =============================================
// CLOUDINARY UPLOAD
// =============================================
async function uploadToCloudinary(file, progressId) {
  return new Promise((resolve, reject) => {
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", UPLOAD_PRESET);
    const xhr = new XMLHttpRequest();
    xhr.open("POST", `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, true);
    xhr.upload.onprogress = e => {
      if (e.lengthComputable) {
        const percent = (e.loaded / e.total) * 100;
        document.getElementById(progressId).style.width = `${percent}%`;
      }
    };
    xhr.onload = () => {
      if (xhr.status === 200) {
        const response = JSON.parse(xhr.responseText);
        resolve(response.secure_url);
      } else {
        reject(new Error("Upload failed: " + xhr.status));
      }
    };
    xhr.onerror = () => reject(new Error("Network error"));
    xhr.send(formData);
  });
}

// =============================================
// FILE UPLOAD HANDLER
// =============================================
function setupUpload(areaId, inputId, previewId, progressId) {
  const area = document.getElementById(areaId);
  const input = document.getElementById(inputId);
  const preview = previewId ? document.getElementById(previewId) : null;
  const progress = document.getElementById(progressId);

  if (area && input) {
    area.onclick = () => input.click();

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      area.addEventListener(eventName, e => e.preventDefault());
    });

    area.addEventListener('drop', e => {
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file, preview, progress, areaId);
    });

    input.onchange = e => {
      const file = e.target.files[0];
      if (file) handleFile(file, preview, progress, areaId);
    };
  }
}

async function handleFile(file, previewImg, progressEl, areaId) {
  try {
    progressEl.style.width = "0%";
    if (previewImg && file.type.startsWith('image/')) {
      previewImg.src = URL.createObjectURL(file);
      previewImg.style.display = "block";
    } else if (areaId === "musicAudioUploadArea" && file.type.startsWith('audio/')) {
      const audioEl = document.getElementById("musicAudioPreview");
      audioEl.src = URL.createObjectURL(file);
      audioEl.style.display = "block";
    }

    const url = await uploadToCloudinary(file, progressEl.id);

    if (previewImg && file.type.startsWith('image/')) {
      previewImg.dataset.cloudinaryUrl = url;
    } else if (areaId === "musicAudioUploadArea") {
      document.getElementById("musicAudioPreview").dataset.cloudinaryUrl = url;
    } else if (areaId === "editUploadArea") {
      document.getElementById("editPreview").dataset.cloudinaryUrl = url;
    }

    progressEl.style.width = "100%";
  } catch (err) {
    alert("Upload failed: " + err.message);
    progressEl.style.width = "0%";
  }
}

// Initialize all upload areas
setupUpload("heroUploadArea", "heroFileInput", "heroPreview", "heroProgress");
setupUpload("newUploadArea", "newFileInput", "newPreview", "newProgress");
setupUpload("trendingUploadArea", "trendingFileInput", "trendingPreview", "trendingProgress");
setupUpload("popularUploadArea", "popularFileInput", "popularPreview", "popularProgress");
setupUpload("musicCoverUploadArea", "musicCoverFileInput", "musicCoverPreview", "musicCoverProgress");
setupUpload("musicAudioUploadArea", "musicAudioFileInput", null, "musicAudioProgress");
setupUpload("editUploadArea", "editFileInput", "editPreview", "editProgress");

// =============================================
// SAVE HERO SECTION
// =============================================
document.getElementById("saveHero").onclick = async () => {
  try {
    const updates = {
      title: document.getElementById("heroTitle").value.trim(),
      description: document.getElementById("heroDescription").value.trim(),
      badge: document.getElementById("heroBadge").value.trim() || "16+",
      rating: document.getElementById("heroRating").value.trim(),
      year: document.getElementById("heroYear").value.trim(),
      duration: document.getElementById("heroDuration").value.trim(),
      backgroundImage: document.getElementById("heroPreview").dataset.cloudinaryUrl || null,
      updatedAt: firebase.database.ServerValue.TIMESTAMP
    };
    await db.ref("/content/hero").update(updates);
    alert("Hero section saved successfully!");
  } catch (err) {
    alert("Error saving hero: " + err.message);
  }
};

// =============================================
// ADD NEW MOVIE / TRACK (generic for movies)
// =============================================
async function saveNewItem(category, titleId, yearId, previewId) {
  try {
    const title = document.getElementById(titleId).value.trim();
    const year = document.getElementById(yearId).value.trim();
    const url = document.getElementById(previewId).dataset.cloudinaryUrl;

    if (!title || !year) {
      alert("Title and Year are required!");
      return;
    }

    const snap = await db.ref(`/content/${category}`)
      .orderByChild("order")
      .limitToLast(1)
      .once("value");
    let maxOrder = 0;
    snap.forEach(child => maxOrder = child.val().order || 0);

    const item = {
      title,
      year,
      image: url || null,
      order: maxOrder + 100,
      createdAt: firebase.database.ServerValue.TIMESTAMP
    };

    await db.ref(`/content/${category}`).push(item);

    document.getElementById(titleId).value = "";
    document.getElementById(yearId).value = "";
    document.getElementById(previewId).src = "";
    document.getElementById(previewId).style.display = "none";
    document.getElementById(previewId).dataset.cloudinaryUrl = "";

    alert(`Item added to ${category}!`);
  } catch (err) {
    alert("Error: " + err.message);
  }
}

document.getElementById("saveNewRelease").onclick = () => saveNewItem("new", "newTitle", "newYear", "newPreview");
document.getElementById("saveTrending").onclick = () => saveNewItem("trending", "trendingTitle", "trendingYear", "trendingPreview");
document.getElementById("savePopular").onclick = () => saveNewItem("popular", "popularTitle", "popularYear", "popularPreview");

// =============================================
// ADD NEW MUSIC TRACK
// =============================================
async function saveNewMusic() {
  try {
    const title  = document.getElementById("musicTitle").value.trim();
    const artist = document.getElementById("musicArtist").value.trim();
    const album  = document.getElementById("musicAlbum").value.trim();
    const year   = document.getElementById("musicYear").value.trim();
    const genre  = document.getElementById("musicGenre").value.trim();

    const coverUrl = document.getElementById("musicCoverPreview").dataset.cloudinaryUrl;
    const audioUrl = document.getElementById("musicAudioPreview").dataset.cloudinaryUrl;

    if (!title || !artist || !audioUrl) {
      alert("Title, Artist and Audio File are required!");
      return;
    }

    const snap = await db.ref("/content/music")
      .orderByChild("order")
      .limitToLast(1)
      .once("value");
    let maxOrder = 0;
    snap.forEach(child => maxOrder = child.val().order || 0);

    const track = {
      title,
      artist,
      album: album || null,
      year: year || null,
      genre: genre || null,
      cover: coverUrl || null,
      audio: audioUrl,
      order: maxOrder + 100,
      createdAt: firebase.database.ServerValue.TIMESTAMP
    };

    await db.ref("/content/music").push(track);

    // Clear form
    ['musicTitle','musicArtist','musicAlbum','musicYear','musicGenre'].forEach(id => 
      document.getElementById(id).value = ""
    );
    document.getElementById("musicCoverPreview").src = "";
    document.getElementById("musicCoverPreview").style.display = "none";
    document.getElementById("musicCoverPreview").dataset.cloudinaryUrl = "";
    document.getElementById("musicAudioPreview").src = "";
    document.getElementById("musicAudioPreview").style.display = "none";
    document.getElementById("musicAudioPreview").dataset.cloudinaryUrl = "";

    alert("Track added successfully!");
  } catch (err) {
    alert("Error adding track: " + err.message);
  }
}

document.getElementById("saveMusicTrack").onclick = saveNewMusic;
document.getElementById("toggleMusicForm").onclick = () =>
  document.getElementById("musicForm").classList.toggle("hidden");

// =============================================
// DELETE
// =============================================
function deleteItem(category, key) {
  if (!confirm("Delete this item? This action cannot be undone.")) return;
  db.ref(`/content/${category}/${key}`).remove();
}

// =============================================
// REORDER AFTER DRAG & DROP
// =============================================
async function saveOrder(containerId, category) {
  const container = document.getElementById(containerId);
  const items = Array.from(container.children);
  const updates = {};
  items.forEach((el, index) => {
    const key = el.dataset.key;
    if (key) updates[`${key}/order`] = (index + 1) * 100;
  });
  if (Object.keys(updates).length > 0) {
    await db.ref(`/content/${category}`).update(updates);
  }
}

function initSortable(containerId, category) {
  new Sortable(document.getElementById(containerId), {
    animation: 180,
    handle: ".drag-handle",
    ghostClass: "sortable-ghost",
    chosenClass: "sortable-chosen",
    onEnd: () => saveOrder(containerId, category)
  });
}

// =============================================
// EDIT MODAL (basic support for music & movies)
// =============================================
function openEditModal(category, key, title, subtitle, imageUrl) {
  currentEditingKey = key;
  currentEditingCategory = category;
  originalImageUrl = imageUrl || '';

  document.getElementById('editCategory').value = category.charAt(0).toUpperCase() + category.slice(1);
  document.getElementById('editTitle').value = title;
  document.getElementById('editYear').value = subtitle;

  // Adjust label for music vs movies
  const subtitleLabel = document.getElementById('editSubtitleLabel');
  subtitleLabel.textContent = (category === 'music') ? 'Artist' : 'Year';

  const preview = document.getElementById('editPreview');
  const currentText = document.getElementById('editCurrentImageText');

  preview.src = '';
  preview.style.display = 'none';
  preview.dataset.cloudinaryUrl = '';
  document.getElementById('editProgress').style.width = '0%';

  if (imageUrl && !imageUrl.includes('placeholder')) {
    preview.src = imageUrl;
    preview.style.display = 'block';
    currentText.textContent = 'Current will be kept unless replaced';
  } else {
    currentText.textContent = 'No image/cover';
  }

  document.getElementById('editModal').classList.remove('hidden');
}

document.getElementById('saveEditBtn').onclick = async () => {
  if (!currentEditingKey || !currentEditingCategory) return;

  const title = document.getElementById('editTitle').value.trim();
  const subtitle = document.getElementById('editYear').value.trim();
  const newImageUrl = document.getElementById('editPreview').dataset.cloudinaryUrl;

  if (!title || !subtitle) {
    alert("Required fields cannot be empty!");
    return;
  }

  try {
    const updates = {
      title,
      updatedAt: firebase.database.ServerValue.TIMESTAMP
    };

    if (currentEditingCategory === 'music') {
      updates.artist = subtitle;
    } else {
      updates.year = subtitle;
    }

    if (newImageUrl) {
      updates[currentEditingCategory === 'music' ? 'cover' : 'image'] = newImageUrl;
    }

    await db.ref(`/content/${currentEditingCategory}/${currentEditingKey}`).update(updates);
    alert("Item updated successfully!");
    document.getElementById('editModal').classList.add('hidden');
  } catch (err) {
    alert("Error updating: " + err.message);
  }
};

document.getElementById('deleteEditBtn').onclick = () => {
  if (confirm("Delete this item?")) {
    deleteItem(currentEditingCategory, currentEditingKey);
    document.getElementById('editModal').classList.add('hidden');
  }
};

document.getElementById('cancelEdit').onclick = () => {
  document.getElementById('editModal').classList.add('hidden');
};

document.getElementById('editModal').onclick = e => {
  if (e.target === e.currentTarget) document.getElementById('editModal').classList.add('hidden');
};

// =============================================
// RENDER FUNCTIONS
// =============================================
function renderMovies(containerId, items, category) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  if (items.length === 0) {
    container.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:var(--text-dim); padding:2rem 0;">No movies in this category yet</p>';
    return;
  }

  items.sort((a, b) => (a.order ?? 999999) - (b.order ?? 999999));

  container.innerHTML = items.map(item => `
    <div class="item-card" data-key="${item.key}" data-category="${category}">
      <div class="drag-handle"><span class="material-symbols-rounded">drag_handle</span></div>
      <img src="${item.image || 'https://via.placeholder.com/320x180?text=No+Poster'}" alt="${item.title}"/>
      <div class="item-info">
        <div class="item-title">${item.title}</div>
        <div class="item-year">${item.year}</div>
      </div>
      <div class="item-actions">
        <button class="btn btn-primary" style="padding:0.45rem 1rem; font-size:0.88rem;"
          onclick="openEditModal('${category}', '${item.key}', \`${item.title.replace(/`/g,'\\`').replace(/'/g,"\\'")}\`, '${item.year}', '${item.image || ''}')">
          Edit
        </button>
        <button class="btn btn-danger" style="padding:0.45rem 1rem; font-size:0.88rem;"
          onclick="deleteItem('${category}', '${item.key}')">
          Delete
        </button>
      </div>
    </div>
  `).join('');

  container.querySelectorAll('.item-card').forEach(card => {
    card.addEventListener('click', e => {
      if (e.target.tagName === 'BUTTON' || e.target.closest('.drag-handle')) return;
      const key = card.dataset.key;
      const cat = card.dataset.category;
      const titleEl = card.querySelector('.item-title');
      const yearEl = card.querySelector('.item-year');
      const img = card.querySelector('img').src;
      openEditModal(cat, key, titleEl.textContent, yearEl.textContent, img);
    });
  });

  initSortable(containerId, category);
}

function renderMusicTracks(containerId, items) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  if (items.length === 0) {
    container.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:var(--text-dim); padding:2rem 0;">No tracks yet</p>';
    return;
  }

  items.sort((a, b) => (a.order ?? 999999) - (b.order ?? 999999));

  container.innerHTML = items.map(item => `
    <div class="item-card" data-key="${item.key}" data-category="music">
      <div class="drag-handle"><span class="material-symbols-rounded">drag_handle</span></div>
      <img src="${item.cover || 'https://via.placeholder.com/230x230?text=No+Cover'}" alt="${item.title}"/>
      <div class="item-info">
        <div class="item-title">${item.title}</div>
        <div class="item-year">${item.artist} • ${item.album || 'Single'}</div>
      </div>
      <div class="item-actions">
        <button class="btn btn-primary" style="padding:0.45rem 1rem; font-size:0.88rem;" 
          onclick="openEditModal('music', '${item.key}', \`${item.title.replace(/`/g,'\\`').replace(/'/g,"\\'")}\`, '${item.artist}', '${item.cover || ''}')">
          Edit
        </button>
        <button class="btn btn-danger" style="padding:0.45rem 1rem; font-size:0.88rem;"
          onclick="deleteItem('music', '${item.key}')">
          Delete
        </button>
      </div>
    </div>
  `).join('');

  container.querySelectorAll('.item-card').forEach(card => {
    card.addEventListener('click', e => {
      if (e.target.tagName === 'BUTTON' || e.target.closest('.drag-handle')) return;
      const key = card.dataset.key;
      const titleEl = card.querySelector('.item-title');
      const artistEl = card.querySelector('.item-year');
      const img = card.querySelector('img').src;
      const artist = artistEl.textContent.split(' • ')[0];
      openEditModal('music', key, titleEl.textContent, artist, img);
    });
  });

  initSortable(containerId, "music");
}

// =============================================
// LOAD ALL DATA
// =============================================
function loadAllContent() {
  // Hero
  db.ref("/content/hero").once("value", snap => {
    const h = snap.val() || {};
    document.getElementById("heroTitle").value = h.title || "";
    document.getElementById("heroDescription").value = h.description || "";
    document.getElementById("heroBadge").value = h.badge || "16+";
    document.getElementById("heroRating").value = h.rating || "";
    document.getElementById("heroYear").value = h.year || "";
    document.getElementById("heroDuration").value = h.duration || "";
    if (h.backgroundImage) {
      const p = document.getElementById("heroPreview");
      p.src = h.backgroundImage;
      p.style.display = "block";
      p.dataset.cloudinaryUrl = h.backgroundImage;
    }
  });

  // Movies - real-time
  ["new", "trending", "popular"].forEach(cat => {
    db.ref(`/content/${cat}`).on("value", snap => {
      const items = [];
      snap.forEach(child => {
        items.push({ key: child.key, ...child.val() });
      });
      renderMovies(`${cat}List`, items, cat);
    });
  });

  // Music - real-time
  db.ref("/content/music").on("value", snap => {
    const tracks = [];
    snap.forEach(child => {
      tracks.push({ key: child.key, ...child.val() });
    });
    renderMusicTracks("musicList", tracks);
  });
}

// =============================================
// TOGGLE ADD FORMS
// =============================================
document.getElementById("toggleNewForm").onclick = () =>
  document.getElementById("newReleaseForm").classList.toggle("hidden");
document.getElementById("toggleTrendingForm").onclick = () =>
  document.getElementById("trendingForm").classList.toggle("hidden");
document.getElementById("togglePopularForm").onclick = () =>
  document.getElementById("popularForm").classList.toggle("hidden");

</script>
</body>
</html>
